<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: salesforce | KayaMemo]]></title>
  <link href="http://kayakuguri.github.io/blog/categories/salesforce/atom.xml" rel="self"/>
  <link href="http://kayakuguri.github.io/"/>
  <updated>2014-12-12T16:05:29+09:00</updated>
  <id>http://kayakuguri.github.io/</id>
  <author>
    <name><![CDATA[萱潜]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[[salesforce]標準画面でVFからポーリング処理をJSのリロードで実現する]]></title>
    <link href="http://kayakuguri.github.io/blog/2014/12/12/reload-vf-iframe/"/>
    <updated>2014-12-12T15:40:08+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2014/12/12/reload-vf-iframe</id>
    <content type="html"><![CDATA[<p>やりたかった事としては、カスタムオブジェクトの詳細画面に、VisualForceで地図を表示させ、<br/>
そのVF内のJSからリロード処理をsettimeoutとかで呼び出してポーリングさせるようにしたかった。</p>

<!-- more -->


<p>作成したVisualForceのページを詳細画面に埋め込む方法などは、以前に書いた記事を参考にどうぞ。</p>

<p><a href="http://kayakuguri.github.io/blog/2014/11/21/add-custom-vf-page/">[salesforce]オブジェクトの詳細ページに作成したVisualForceページを埋め込む</a></p>

<p>で、上記の方法でVisualForceに埋め込むわけだけれど、そのままそのVisualForce内からJSでリロード処理を書くと、上手く動作しない。<br/>
原因は、埋め込まれたVisualForceは標準画面から見るとiframeとなっており、しかもその中身は別のドメインとなっている。<br/>
なので、子ページが別ドメインの親ドメインをリロードしようとしてクロスドメインのエラーが発生していた、というわけ。</p>

<p>例えば、詳細ページのURLが以下のようになっている場合、</p>

<blockquote><p><a href="https://cs6.salesforce.com/xxxxIDxxxx">https://cs6.salesforce.com/xxxxIDxxxx</a></p></blockquote>

<p>読み込まれているVFページのURLは以下のようになっていた。</p>

<blockquote><p><a href="https://c.cs6.visual.force.com/servlet/servlet.Integration?lid=xxxxVFIDxxxx&amp;ic=1">https://c.cs6.visual.force.com/servlet/servlet.Integration?lid=xxxxVFIDxxxx&amp;ic=1</a></p></blockquote>

<p>これはJSの仕様でクロスドメイン(オリジン)がダメなので、根本的に回避する手立てはない。</p>

<p>しかし、バッドノウハウ的に対応するならば、以下のように、同じドメインからリロードをかけるようにしてやれば回避できるよう。</p>

<ol>
<li><strong>静的リソース</strong>に、リロードするためだけのJSを埋め込んだファイルをアップしておく</li>
<li>VFページ上に非表示にしたiframeタグを記述しておく</li>
<li>リロードするタイミングでそのiframeに、1のファイルを表示させる</li>
<li>静的リソース内からリロードが走り、無事リロードが行われる</li>
</ol>


<p>現状では、標準ページのドメインと静的リソースの表示ドメインは同じなので動作する。<br/>
標準ページから見れば、孫からリロードを要求される形。</p>

<p>1.の中身は以下のような内容</p>

<pre><code>&lt;html&gt;&lt;head&gt;&lt;script&gt;parent.parent.location.reload();&lt;/script&gt;&lt;/head&gt;&lt;/html&gt;
</code></pre>

<p>これを、<code>OpenerReload</code>として静的リソースに登録しておく。<br/>
VF側のJSはこんな内容</p>

<pre><code>setTimeout(reloadAndClose, 60000);
function reloadAndClose() {
  var iframe = document.getElementById('iframe');
  var urlbase = 'https://cs6.salesforce.com';
  iframe.src = urlbase + '{!URLFOR($Resource.OpenerReload)}';
}
</code></pre>

<p>埋め込むiframeのタグ</p>

<pre><code>&lt;iframe src="about:blank" id="iframe" style="display:none;"&gt;&lt;/iframe&gt;
</code></pre>

<p>静的リソースがいつまで同じドメインでアクセスできるかわからないので、あまりオススメは出来ないけれど、他に方法がなさそう。<br/>
仕事でやる場合には避ける方が無難かもしれない。</p>

<h3>参考</h3>

<p><a href="http://blog.livedoor.jp/minoaw/archives/1654198.html">[Salesforce]標準画面からクロスドメインなVisualforce画面を開き、自分を更新させる : minoawのブログ</a><br/>
ほぼこのまんまです。ありがとうございます。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[salesforce]オブジェクトの詳細ページに作成したVisualForceページを埋め込む]]></title>
    <link href="http://kayakuguri.github.io/blog/2014/11/21/add-custom-vf-page/"/>
    <updated>2014-11-21T12:14:39+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2014/11/21/add-custom-vf-page</id>
    <content type="html"><![CDATA[<p>ページレイアウトで追加するのですが、作成しないと選択肢に出てこないので少し悩みました。</p>

<!-- more -->


<p>今回は、サンプルオブジェクト、というオブジェクトを作成しました。<br/>
今は名前が表示されているだけです。</p>

<p><img src="/images/2014/11/custom_vf01.jpg" alt="詳細画面" /></p>

<p>で、レイアウトの編集画面に行ってみても、VisualForceページの追加タブはありません。</p>

<p><img src="/images/2014/11/custom_vf02.jpg" alt="タブがない" /></p>

<p>なのでまずは、作成したいオブジェクトをコントローラーに指定したpageを作成します。<br/>
ここでは、<code>hoge__c</code>というオブジェクトにします。<br/>
<code>standardController="hoge__c"</code>がポイントです。<br/>
内容は新規で作成したものママです。</p>

<pre><code>&lt;apex:page standardController="hoge__c"&gt;
&lt;!-- Begin Default Content REMOVE THIS --&gt;
&lt;h1&gt;Congratulations&lt;/h1&gt;
This is your new Page
&lt;!-- End Default Content REMOVE THIS --&gt;
&lt;/apex:page&gt;
</code></pre>

<p><img src="/images/2014/11/custom_vf03.jpg" alt="VFページ作成" /></p>

<p>で、再度、サンプルオブジェクトのレイアウト編集画面を見てみると、<br/>
見事、Visualforceページ、というタブが追加されています。</p>

<p><img src="/images/2014/11/custom_vf04.jpg" alt="タブがある" /></p>

<p>選択すると、先程作成したpageの名前が出てきます。</p>

<p><img src="/images/2014/11/custom_vf05.jpg" alt="ページの選択" /></p>

<p>これを、任意の場所にドラッグ＆ドロップすると、以下のように追加され、ページとして表示できます。</p>

<p><img src="/images/2014/11/custom_vf06.jpg" alt="レイアウトに追加" /></p>

<p>保存して詳細画面を確認すると、見事作成した文章が表示されました。</p>

<p><img src="/images/2014/11/custom_vf07.jpg" alt="追加完了" /></p>

<p>後はVFpageの中身をカスタマイズすれば好きなものを出す事が出来ます。<br/>
googlemapなんかも思いのまま。</p>

<p><img src="/images/2014/11/custom_vf08.jpg" alt="地図の表示" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Force.com IDE for Eclipse plug-inをインストール]]></title>
    <link href="http://kayakuguri.github.io/blog/2014/11/13/force-dot-com-ide-for-eclipse/"/>
    <updated>2014-11-13T17:35:25+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2014/11/13/force-dot-com-ide-for-eclipse</id>
    <content type="html"><![CDATA[<p>いつのまにやらForce.com IDEの<a href="http://salesforce.stackexchange.com/questions/47653/where-can-i-get-a-standalone-version-of-the-force-com-ide">スタンドアロン版が開発終了してしまっているらしく</a>(未確認)、<br/>
仕方がないので、Eclipseのインストールからしてみました。</p>

<!-- more -->


<p>環境は、macのmavericks(10.9)です。</p>

<h2>Javaのインストール</h2>

<p>まずは、JAVAのバージョンを確認。<br/>
ターミナルからコマンドで確認できる。</p>

<pre><code>$ java -version
java version "1.6.0_65"
Java(TM) SE Runtime Environment (build 1.6.0_65-b14-462-11M4609)
Java HotSpot(TM) 64-Bit Server VM (build 20.65-b04-462, mixed mode)
</code></pre>

<p>Force.com IDEは、</p>

<blockquote><p>Java SE Runtime Environment 6 (v1.6) or later</p></blockquote>

<p>となっているんだけど、7以上でないとダメなよう。<br/>
<a href="https://developer.salesforce.com/forums/?id=906F0000000AbEjIAK">https://developer.salesforce.com/forums/?id=906F0000000AbEjIAK</a><br/>
なので、以下から7をダウンロード。<br/>
<a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html">http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html</a></p>

<p><img src="/images/2014/11/java01.jpg" alt="java" /></p>

<p>中ほどにあるリンクページから、<code>jdk-7u71-macosx-x64.dmg</code>をダウンロード。</p>

<p><img src="/images/2014/11/java02.jpg" alt="java download" /></p>

<p>ダブルクリックしてインストール開始。</p>

<p><img src="/images/2014/11/java03.jpg" alt="java インストール" /></p>

<p>特筆すべき事はなく、次、次、でOK。</p>

<p><img src="/images/2014/11/java04.jpg" alt="java インストール中" /></p>

<p>完了。</p>

<p><img src="/images/2014/11/java05.jpg" alt="java インストール完了" /></p>

<p>再度バージョンを確認。</p>

<pre><code>$ java -version
java version "1.7.0_71"
Java(TM) SE Runtime Environment (build 1.7.0_71-b14)
Java HotSpot(TM) 64-Bit Server VM (build 24.71-b01, mixed mode)
</code></pre>

<h2>Eclipseのインストール</h2>

<p>ググったら出てくる公式の日本語ページ最下部からインストールの解説ページへ。<br/>
<a href="https://developer.salesforce.com/page/JP:Force.com_IDE">https://developer.salesforce.com/page/JP:Force.com_IDE</a></p>

<p><img src="/images/2014/11/ide01.jpg" alt="force.com ide 解説" /></p>

<p><a href="https://developer.salesforce.com/page/JP:Force.com_IDE_Installation">https://developer.salesforce.com/page/JP:Force.com_IDE_Installation</a><br/>
Eclipseのダウンロードページへ。4.2でも4.3でもいい、との事なので、今回は4.3で。</p>

<p><img src="/images/2014/11/ide02.jpg" alt="インストール方法" /></p>

<p>飛び先のページで、<code>Eclipse IDE for Java Developers</code>をダウンロード。<br/>
自分はmacなので、mac64bit版をダウンロード。</p>

<p><img src="/images/2014/11/ide03.jpg" alt="eclipse ダウンロード" /></p>

<p>次のページでダウンロード開始。</p>

<p><img src="/images/2014/11/ide04.jpg" alt="eclipse ダウンロード" /></p>

<p>ダウンロードは自動で始まる。<br/>
(寄付してね！画面が表示されるけど、eclipse自体は無料で使える)</p>

<p><img src="/images/2014/11/ide05.jpg" alt="eclipse ダウンロード" /></p>

<p>ダウンロードしたファイル(今回は、<code>eclipse-java-kepler-R-macosx-cocoa-x86_64.tar.gz</code>)をダブルクリックして解凍。<br/>
macの場合はインストールはなく、解凍して出来たファルダごと、アプリケーションフォルダに突っ込めばOK。<br/>
(別に入れなくても大丈夫なはず)</p>

<p><img src="/images/2014/11/ide06.jpg" alt="アプリケーションフォルダへ" /></p>

<p>で、起動。<br/>
ただし、自分の環境(Mavericks)では起動が出来ず、壊れているという表記。<br/>
これは、Mountain Lionから導入されたGateKeeperによってApp Store以外からインストールしようとした場合に表示される警告、のよう。<br/>
いきなり実行ファイルがゴミ箱に捨てられるってのがなんともすごい。</p>

<p><img src="/images/2014/11/ide07.jpg" alt="起動失敗" /></p>

<p>以下を参考に、実行を許可して、改めて起動。<br/>
<a href="http://park1.wakwak.com/~ima/macosx_eclipse0001.html">[OSX]Mountain Lion(10.8)でEclipse4.3(kepler)を日本語化して使う | ごった煮 &ndash; tips about programming and building a server</a></p>

<p>警告は出るけど無視。</p>

<p><img src="/images/2014/11/ide08.jpg" alt="接続警告" /></p>

<p>最初にワークスペースを設定しろ、と言われるので、とりあえずデフォルトのままで起動する。</p>

<p><img src="/images/2014/11/ide09.jpg" alt="ワークスペース" /></p>

<p>起動後、welcomeスクリーンが表示されるが、とりあえずこのまま放置して、<br/>
上部のメニューから、Help &ndash;> Install New Software を選択。</p>

<p><img src="/images/2014/11/ide10.jpg" alt="Install New Software" /></p>

<p>ネットワークの接続を許可して…、<br/>
あとは上記公式の解説ページ(英語)と同じ手順となりますが、<br/>
<code>Add…</code>をクリック。</p>

<p><img src="/images/2014/11/ide11.jpg" alt="Add" /></p>

<p>Nameは適当に。<br/>
Locationに、<code>http://media.developerforce.com/force-ide/eclipse42</code>と入力。<br/>
OKをクリック。</p>

<p><img src="/images/2014/11/ide12.jpg" alt="Addリポジトリ" /></p>

<p>結果が表示されるので、リストに表示された、<code>Force.com IDE</code>にチェックを入れ、<br/>
<code>Next</code>をクリック。</p>

<p><img src="/images/2014/11/ide13.jpg" alt="インストール" /></p>

<p>ダウンロードされ、インストール準備完了。  <br/>
<code>Next</code>をクリック。</p>

<p><img src="/images/2014/11/ide14.jpg" alt="ダウンロード完了" /></p>

<p>ライセンス情報が表示されるので、一通り目を通してから(通してから…)、<br/>
<code>I accept the terms of license agreements</code>にチェックを入れて、<code>Finish</code>をクリック。</p>

<p><img src="/images/2014/11/ide15.jpg" alt="ライセンス" /></p>

<p>で、インストールが始まる。</p>

<p><img src="/images/2014/11/ide16.jpg" alt="インストール開始" /></p>

<p>インストール後、再起動が必要、との事なので<code>Yes</code>をクリックして、eclipseを再起動。</p>

<p><img src="/images/2014/11/ide17.jpg" alt="再起動" /></p>

<p>これでインストールは完了したわけだけれども、ウインドウ構成など見た目をForce.com仕様に変更する。<br/>
上部メニューの、Window &ndash;> Open Perspective &ndash;> Other を選択。</p>

<p><img src="/images/2014/11/ide18.jpg" alt="Perspective" /></p>

<p>Force.comを選択して、OK。</p>

<p><img src="/images/2014/11/ide19.jpg" alt="Force.com選択" /></p>

<p>これで、Force.com IDEのインストールは完了。</p>

<p><img src="/images/2014/11/ide20.jpg" alt="完了！" /></p>

<h2>プロジェクトの作成</h2>

<p>作成は、スタンドアロン版と同じだった。<br/>
上部メニューから、File &ndash;> New &ndash;> Force.com Project を選択</p>

<p><img src="/images/2014/11/ide21.jpg" alt="プロジェクトの作成" /></p>

<p>プロジェクトの名前と、環境のユーザ名、パスワード、セキュリティトークン(必要なら)と、環境を選択し、Finish。</p>

<p><img src="/images/2014/11/ide22.jpg" alt="接続情報" /></p>

<p>これで開発環境が整った。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[salesforce]apex Rest APIでPOSTでデータを送信する]]></title>
    <link href="http://kayakuguri.github.io/blog/2014/10/27/apex-rest-post/"/>
    <updated>2014-10-27T18:49:51+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2014/10/27/apex-rest-post</id>
    <content type="html"><![CDATA[<p>getでは送信したデータはすぐに取得できたのですが、<br/>
postでの送信方法とデータ取得方法がわからずに迷走しまいした。<br/>
結論は、送信側の話、だったのですが。</p>

<!-- more -->


<p>GETの場合は以下のコードで取得可能でした。<br/>
簡単。</p>

<p>送信データ</p>

<pre><code>?userid=123&amp;name=hoge
</code></pre>

<p>apex</p>

<pre><code>@RestResource(urlMapping='/GetDataSample/test')

global with sharing class GetDataSampleAPI {
    @HttpGet
    global static String doGet(){
        RestRequest req = RestContext.request;
        String userid = req.params.get('userid');
        String name = req.params.get('hoge');
    }
}
</code></pre>

<p>実は、POSTの場合も、apexのコードは全く同じで取得する事が出来ました。<br/>
以下、取得出来たコードです。</p>

<pre><code>@RestResource(urlMapping='/GetDataSample/test')

global with sharing class GetDataSampleAPI {
    @HttpPost
    global static String doPost(){
        RestRequest req = RestContext.request;
        String userid = req.params.get('userid');
        String name = req.params.get('hoge');
    }
}
</code></pre>

<p>ただし、送信する際にヘッダーを正しく指定してやったり、送信形式に注意してやる必要がありました。<br/>
PHPのcurlで実装していたのですが、大いに迷走していたのは、salesforce側の話ではなく、<br/>
PHPでの送信方法の問題でしたとさ…。</p>

<p>送信出来たコード<br/>
(<a href="https://github.com/nkjm/Force.com-OAuth-Toolkit-for-PHP">このライブラリ</a>を使用して送信する前提)</p>

<pre><code>$url = "$oauth-&gt;instance_url/services/apexrest/GetDataSample/test";
$curl = curl_init($url);

$POST_DATA = array(
    'userid' =&gt; '123',
    'hoge' =&gt; 'fugafuga'
);

curl_setopt($curl, CURLOPT_POST, TRUE);
curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($POST_DATA));
curl_setopt($curl, CURLOPT_HEADER, false);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
curl_setopt($curl, CURLOPT_HTTPHEADER, array('Content-type: application/x-www-form-urlencoded;charset=UTF-8', "Authorization: OAuth " . $oauth-&gt;access_token));

$output= curl_exec($curl);
curl_close($curl);
</code></pre>

<p>ポイントは以下の２つです。</p>

<p>１）<br/>
<code>Content-type</code>を、<code>application/x-www-form-urlencoded</code>という、POSTでデータを送信する際の標準タイプを指定しています。<br/>
通常はデフォルトでこれなのですが、salesforceのAPIにPOSTする場合は明示的に指定してやる必要があるようです。(たぶん)<br/>
ちなみに、apex restは、<code>multipart/form-data</code>タイプはサポートしていないようです。</p>

<p>２）<br/>
１のタイプで指定してやると、送信するデータは<code>userid=123&amp;hoge=fugafuga</code>のように、GETと同じ形で取得できるようになるようです。<br/>
なので送信する際にそのような形に変換してやる必要があるようで、それが以下の記述となります。</p>

<pre><code>curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($POST_DATA));
</code></pre>

<h3>参考</h3>

<p><a href="http://qiita.com/khirose/items/870ffec6ce4562f54c9d">PHP小ネタ &ndash; PHPのcurlでPOST &ndash; Qiita</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[salesforce]sandboxでメールが送られない]]></title>
    <link href="http://kayakuguri.github.io/blog/2014/10/22/send-mail-setting-sandbox/"/>
    <updated>2014-10-22T11:49:53+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2014/10/22/send-mail-setting-sandbox</id>
    <content type="html"><![CDATA[<p>salesfoceのsandboxでワークフローメールを作成していたのですが、<br/>
何回やってメールが送信されない。<br/>
ワークフローは間違ってないし、有効化もできてるし……と思っていたら、設定の問題でした。</p>

<!-- more -->


<p>ググってみると、<code>メール管理</code>の<code>送信</code>から設定すると書いてあるのですが、そんなが項目ない。
そもそもの権限の問題かと思っていたら、いつからか名前が変わっているよう。<br/>
ググってるとよくある……。</p>

<p><code>管理</code>&ndash;><code>メール管理</code>&ndash;><code>配信可能性</code><br/>
に、あった。配信可能性、って。</p>

<p><img src="/images/2014/10/send_mail_setting.jpg" alt="配信可能性" /></p>

<p>この中で、<code>アクセス権</code>を、<code>システムメールのみ</code>から、<code>すべてのメール</code>に変更し、保存する。<br/>
これでメールの送信が出来るようになった。</p>

<h3>参考</h3>

<p><a href="http://dackdive.hateblo.jp/entry/2014/01/26/165752"> [salesforce] Sandbox組織だとメール通知ができない問題 &ndash; dackdive&#39;s blog</a></p>
]]></content>
  </entry>
  
</feed>
