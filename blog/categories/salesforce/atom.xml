<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: salesforce | KayaMemo]]></title>
  <link href="http://kayakuguri.github.io/blog/categories/salesforce/atom.xml" rel="self"/>
  <link href="http://kayakuguri.github.io/"/>
  <updated>2014-09-12T11:45:24+09:00</updated>
  <id>http://kayakuguri.github.io/</id>
  <author>
    <name><![CDATA[萱潜]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[[SalesForceキャンペーンメンバーの状況を追加する]]></title>
    <link href="http://kayakuguri.github.io/blog/2014/09/12/campaignmemberstatus/"/>
    <updated>2014-09-12T11:40:25+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2014/09/12/campaignmemberstatus</id>
    <content type="html"><![CDATA[<p>キャンペーンメンバーオブジェクトのデフォルト項目である、<br/>
<code>状況</code>は、デフォルトでは、</p>

<blockquote><p>送信<br/>
レスポンスあり</p></blockquote>

<p>の２つになっている。<br/>
これを独自で追加したい。</p>

<!-- more -->


<p>結論から言うと、仕様上、無理だった。<br/>
以下に同じような質問があった。</p>

<p><a href="https://developer.salesforce.com/forums/ForumsMain?id=906F00000009B5HIAU">キャンペーンメンバーの状況に値を追加したい &ndash; Salesforce Developer Community</a></p>

<blockquote><p>レコードを横断した設定ではなく、キャンペーンレコード毎に状況を設定する必要があります。</p></blockquote>

<ol>
<li>キャンペーンタブから、状況を追加したいキャンペーンレコードの詳細画面を表示</li>
<li>「高度な設定」ボタン押下</li>
<li>メンバーの状況の値の「編集」ボタン押下</li>
<li>メンバー状況の一番下にある、「さらに追加」リンク押下</li>
</ol>


<p>この仕様は謎仕様としても有名？なよう。</p>

<blockquote><p>キャンペーンメンバーの「状況」のクソ仕様(?)を質問した。<br/>
デフォルト値を変更できない件となぜか手入力な仕様について。<br/>
キャンペーンを作るたびに「状況」の選択肢を追加しないとダメな上に、手入力だから後からの集計がヒドイことになる。<br/>
<a href="https://twitter.com/realichiro5221/status/337413167804203009">https://twitter.com/realichiro5221/status/337413167804203009</a></p></blockquote>

<p>解決策としては、同じ<code>状況</code>項目をカスタム項目として作成するしかないよう。<br/>
それでもデフォルトの<code>状況</code>は必須項目になるので、運用がややこしくなりそうだけれど。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SOQLクエリの結果をJSONで出力する]]></title>
    <link href="http://kayakuguri.github.io/blog/2014/09/09/create-json-in-apex/"/>
    <updated>2014-09-09T15:54:29+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2014/09/09/create-json-in-apex</id>
    <content type="html"><![CDATA[<p>SOQLで取得したクエリ内容をJSONにパースして出力する方法。</p>

<!-- more -->


<p>Apexクラス</p>

<pre><code>public class sample
{
    public String text1 {get;set;}

    public sample()
    {

    }    
    public void parseJson()
    {
        String soql = 'SELECT Name FROM Lead';
        List&lt;Account&gt; acct = Database.Query(soql); 
        text1 = JSON.serialize(acct);
    }    
} 
</code></pre>

<p>VisualForceページ</p>

<pre><code>&lt;apex:page showHeader="false" controller="ShowCampaignListController" action="{!parseJson}"&gt;
    {!text1}
&lt;/apex:page&gt;
</code></pre>

<p>出力結果例</p>

<pre><code>[{
    "attributes":
    {
        "type":"Lead",
        "url":"/services/data/v32.0/sobjects/Lead/00QO0000002xxxxxxx"
    },
    "Name":"テストユーザー3",
    "Id":"00QO0000002xxxxxxx"
},
{
    "attributes":
    {
        "type":"Lead",
        "url":"/services/data/v32.0/sobjects/Lead/00QO0000002ooooooo"
    },
    "Name":"テストユーザー2",
    "Id":"00QO0000002ooooooo"
}]
</code></pre>

<p>参考：<a href="http://www.infallibletechie.com/2012/10/generating-json-in-visualforce-page-in.html">Infallible Techie: Generating JSON in Visualforce page in Salesforce</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[SalesForce]ApexでカスタムREST APIを作成する]]></title>
    <link href="http://kayakuguri.github.io/blog/2014/09/08/apex-restapi/"/>
    <updated>2014-09-08T22:30:35+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2014/09/08/apex-restapi</id>
    <content type="html"><![CDATA[<p>apexにて、自作のRestAPIを作成してみました。<br/>
そして、作成したAPIをPHPから叩いてみました。</p>

<!-- more -->


<p>まずは、Salesforce側の設定。<br/>
今回は、GETで指定されたIDのリードデータを取得するもの。</p>

<pre><code>@RestResource(urlMapping='/CustomLead/*')
global with sharing class CustomLeadSample {
    @HttpGet
    global static sObject doGet() {
        RestRequest req = RestContext.request;
        Id LeadID = req.params.get('id');
        try {
            Lead acc = [SELECT Id, Name FROM Lead WHERE Id = :LeadID LIMIT 1];
            return acc;
        } catch (exception e) {
            return null;
        }
    }
}
</code></pre>

<p>公式の解説の最後に載っているものほぼそのままです。<br/>
<a href="https://developer.salesforce.com/page/Creating_REST_APIs_using_Apex_REST">Creating REST APIs using Apex REST &ndash; developer.force.com</a></p>

<p>で、これをPHP側から呼び出します。<br/>
oauth認証は以下の記事のものを使用させてもらっています。<br/>
<a href="http://www.nkjmkzk.net/?p=2328">nkjmkzk.net &raquo; 新しくなったForce.com OAuth Toolkit for phpの使い方 のコメントのフィード</a><br/>
<a href="https://github.com/nkjm/Force.com-OAuth-Toolkit-for-PHP">nkjm/Force.com-OAuth-Toolkit-for-PHP</a></p>

<p><code>@RestResource</code>で作成したAPIは、<code>/services/apexrest/</code>から始まるURLで定義されています。<br/>
また、外部から接続する場合には、<code>接続アプリケーション</code>の設定が必要になります。<br/>
<a href="https://help.salesforce.com/HTViewHelpDoc?id=connected_app_create.htm&amp;language=ja">接続アプリケーションの作成</a><br/>
コールバックURLは今回は必要ないので、適当なローカルURLを指定しています。<br/>
また、パスワードは、(特定のIPアドレスからのアクセスに制限しなかった場合には)<br/>
パスワード＋セキュリティトークン、の形で渡す必要があります。</p>

<pre><code>require_once('sf_oauth.php');
$app_token = 'xxx';
$app_secret = 'xxx';
$app_callback = 'http://localhost:9000/';
$sf_id = 'xxx';
$sf_pass = 'password+security-token';

$oauth = new oauth($app_token, $app_secret, $app_callback);
$oauth-&gt;auth_with_password($sf_id, $sf_pass);

$url = "$oauth-&gt;instance_url/services/apexrest/CustomLead/?id=".'リードのID';
$curl = curl_init($url);
curl_setopt($curl, CURLOPT_HEADER, false);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
curl_setopt($curl, CURLOPT_HTTPHEADER,
    array("Authorization: OAuth $oauth-&gt;access_token",
        "Content-type: application/json"));
$json_response = curl_exec($curl);
$status = curl_getinfo($curl, CURLINFO_HTTP_CODE);
</code></pre>

<p>レスポンスは以下のような形です。</p>

<pre><code>{
    "attributes":
    {
        "type":"Lead",
        "url":"/services/data/v32.0/sobjects/Lead/ユーザーID"
    },
    "Name":"ユーザー名",
    "Id":"ユーザーID"
}
</code></pre>

<p>参考サイト：<br/>
<a href="http://magnet88jp.hateblo.jp/entry/2014/07/09/105848">Salesforce 外部サイトからApexメソッドを呼び出したい &ndash; まぐねっとのブログ</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[SalesForce]テスト時にgetパラメータをセット]]></title>
    <link href="http://kayakuguri.github.io/blog/2014/06/19/salesforce-test-getmethod/"/>
    <updated>2014-06-19T21:01:12+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2014/06/19/salesforce-test-getmethod</id>
    <content type="html"><![CDATA[<p>テスト実行時にページのGETパラメータをセットする方法がわからなかったので調べた。</p>

<!-- more -->


<p>まずは、テストしたいページにパラメータをセット。<br/>
その後、テストしたいクラスを実行、とする。<br/>
パラメータをセットするときには、<code>Test</code>を使う。</p>

<p>[apex]</p>

<pre><code>public with sharing class SampleController {
    public SampleController() {
    }

    public Pagereference view(){
        String pid = ApexPages.CurrentPage().getParameters().get('pid');
        if(pid == '10'){
            //処理
        }else{
            //処理
        }

        return null;
    }
}
</code></pre>

<p>[visualforce] <code>samplePage</code>という名前とする</p>

<pre><code>&lt;apex:page controller="SampleController" action="{!view}"&gt;
なにがしかの画面処理
&lt;/apex:page&gt;
</code></pre>

<p>[テストクラス]</p>

<pre><code>@isTest
private class SampleControllerTest{
    static testMethod void view() {
        PageReference pageRef = Page.samplePage;
        //パラメータをセット
        pageRef.getParameters().put('pId', '10');
        Test.setCurrentPage(pageRef);

        SampleController c = new SampleController();
        c.view();

        //セットしなおし
        pageRef.getParameters().put('pId', '0');
        Test.setCurrentPage(pageRef);

        c.view();
    }
}
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[SalesForce]apex:inputFileで添付されたファイルの種類をチェックする]]></title>
    <link href="http://kayakuguri.github.io/blog/2014/05/30/apex-inputfile-contenttype/"/>
    <updated>2014-05-30T15:59:00+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2014/05/30/apex-inputfile-contenttype</id>
    <content type="html"><![CDATA[<p>添付されたファイルが指定のものかどうかをチェックする。</p>

<!-- more -->


<h4>1.inputタグのacceptで制限</h4>

<p>一番簡単な方法だけど、ブラウザによっては効かないものもあり。<br/>
salseforce独自の方法というわけではなく、一般的なもの。</p>

<p><a href="http://yokano-jp.blogspot.jp/2013/08/accept.html">accept 属性でアップロードするファイルフォーマットを指定</a></p>

<h4>2.contenttypeを取得</h4>

<p>以下のように指定することで、選択されたファイルのcontenttype (MIMEタイプ)を取得出来る。</p>

<p>[VisualForce]</p>

<pre><code>&lt;apex:inputFile fileName="{!upload.name}" value="{!upload.body}" contentType="{!upload.contentType}" /&gt;
</code></pre>

<p>[apexクラス]</p>

<pre><code>//Documentに保存する場合
public Document upload { get; set; }

//確認ボタンが押された場合
public Pagereference confirm() {
    String ctype = upload.ContentType; //ContentTypeを取得
    if(ctype != 'image/jpeg'){
        // エラーにする
    }
}
</code></pre>

<p>以下、主なcontenttype。(METAタイプ)</p>

<table>
<thead>
<tr>
<th>contenttype </th>
<th> 種類</th>
</tr>
</thead>
<tbody>
<tr>
<td>image/jpeg </td>
<td> JPG画像</td>
</tr>
<tr>
<td>application/pdf </td>
<td> PDF</td>
</tr>
<tr>
<td>application/vnd.ms-excel </td>
<td> エクセル(.xls)</td>
</tr>
<tr>
<td>application/vnd.openxmlformats-officedocument.spreadsheetml.sheet </td>
<td> エクセル(.xlsx)</td>
</tr>
<tr>
<td>application/msword </td>
<td> ワード(.doc)</td>
</tr>
<tr>
<td>application/vnd.openxmlformats-officedocument.wordprocessingml.document </td>
<td> ワード(.docx)</td>
</tr>
</tbody>
</table>


<p>ただし、macでエクセルなどを添付した場合に、このcontenttypeが、<br/>
<code>application/octet-stream</code>になってしまった場合があった。<br/>
このタイプはファイルタイプが不明、の場合になるよう。<br/>
(たぶん、使用しているPCが不明なタイプと判断している場合にそうなる可能性がある)</p>

<p>その場合には、拡張子で判断するようにした。</p>

<h4>3.拡張子で判断</h4>

<p>単純に、ファイル名から、ドットで区切って文字列を取得。<br/>
その文字列と判定、とした。<br/>
上記のapexクラスに追記</p>

<pre><code>if(ctype != 'image/jpeg'){
    if(ctype == 'application/octet-stream'){
        List&lt;String&gt; names = upload.Name.split('\\.');
        String dotex = names[names.size() - 1];
        if(dotex != 'jpg'){
            //エラー
        }
    }else{
        //エラー
    }
}
</code></pre>

<h4>まとめ</h4>

<p>これで単純に、ファイルタイプと拡張子によるチェックは出来るかと思います。<br/>
が、PC側で拡張子を変更するだけで偽装できてしまうので、確実なチェックをしようと思うと、別アプローチが必要になるかと思います。</p>
]]></content>
  </entry>
  
</feed>
