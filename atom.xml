<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[KayaMemo]]></title>
  <link href="http://kayakuguri.github.io/atom.xml" rel="self"/>
  <link href="http://kayakuguri.github.io/"/>
  <updated>2017-09-22T19:09:54+09:00</updated>
  <id>http://kayakuguri.github.io/</id>
  <author>
    <name><![CDATA[萱潜]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[PhpStormを使用してPHP UnitのテストをVagrantのリモート上で実行する]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/09/22/laravel-phpunit-vagrant-phpstorm/"/>
    <updated>2017-09-22T19:05:58+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/09/22/laravel-phpunit-vagrant-phpstorm</id>
    <content type="html"><![CDATA[<p>LaravelのUnitテストを実行すべく、ローカルのVagrant環境上でPHP Unitを実行するように設定してみた。</p>

<!-- more -->


<h1>環境</h1>

<ul>
<li>Vagrant

<ul>
<li><a href="https://box.scotch.io/">ScotchBox</a></li>
</ul>
</li>
<li>Laravel 5.5.7</li>
<li>PHP 7.0</li>
</ul>


<h1>PHP Unit</h1>

<p>PHP UnitはCompoerにてプロジェクトディレクトリにインストールする。<br/>
LaravelではデフォルトでComposerに入っているので特に設定はなし。<br/>
(Linuxに入れる必要はない)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"phpunit/phpunit": "~6.0"</span></code></pre></td></tr></table></div></figure>


<h1>PhpStorm</h1>

<p>PhpStormでの設定方法。<br/>
設定したいプロジェクトのルートディレクトリを開いた状態で設定する。</p>

<h2>PHP Interpreter</h2>

<p><code>Preference</code>を開く。<br/>
<code>Languages &amp; Frameworks -&gt; PHP -&gt; Test Frameworks</code>を選択。<br/>
<code>+</code>マークをクリックし、<code>PHPUnit by Remote Interpreter</code>を選択する。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit01.jpg" alt="" /></p>

<p>Interpreterを選択するウインドウが開くが、interpreterがないので作成する。<br/>
右端の<code>...</code>をクリックする。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit02.jpg" alt="" /></p>

<p>ウインドウが開くので、<code>+</code>をクリックし、<code>From Docker, Vagrant, VM, Remote...</code>を選択。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit03.jpg" alt="" /></p>

<p>開いたウインドウで、<code>Vagrant</code>を選択。すると自動で設定が読み込まれるのでそのままOKする。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit04.jpg" alt="" /></p>

<p>OKをクリックすると、SSH接続が行われ情報が自動で読み込まれる。<br/>
そのままでOKなのでOKをクリックする。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit05.jpg" alt="" /></p>

<p>Interpreterを選択する画面に戻るので、作成したInterpreterを選択し、OKをクリック。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit06.jpg" alt="" /></p>

<p>追加したInterpreterでPHPUnitのライブラリを指定するが、Composer経由でのロードになるので、デフォルトの<code>Use Composer autoloader</code>のままでよい。<br/>
Vagrant内でのautolodのパスを指定するので、<code>...</code>をクリック。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit07.jpg" alt="" /></p>

<p>Scothboxは<code>/var/www</code>がホストと共有しているディレクトリになるので、そこから<code>vendor/autoload.php</code>を選択する。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit08.jpg" alt="" /></p>

<p>選択すると、追加されているPHPUnitのバージョンが表示される。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit09.jpg" alt="" /></p>

<p>これでInterpreterの設定は完了。</p>

<h2>Run/Debug Configurations</h2>

<p>Configurationsの設定を行う。</p>

<p>メニューから、<code>Run -&gt; Edit Configurations</code>を選択。</p>

<p><code>+</code>をクリックし、<code>PHPUnit</code>のConfigurationを追加する。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit10.jpg" alt="" /></p>

<p>Nameは適当に書く。<br/>
Test scopeはテストしたいディレクトリを選択する。<br/>
Laravelのtestsディレクトリを指定しておく。（どこでもよい）<br/>
この設定の下部に、Errorと出ているのでFixをクリック。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit11.jpg" alt="" /></p>

<p>PHPの設定ウインドウが開くので、<code>PHP language level</code>はVagrant環境に合わせて<code>7</code>を選択。<br/>
<code>CLI Interpreter</code>は設定したinterpreterを選択する。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit12.jpg" alt="" /></p>

<p>OKで閉じる。</p>

<h2>実行</h2>

<p>右上のセレクトボックスが、先ほど作成したConfigurationが選択されている状態になっているはずなので、そのまま緑の三角をクリック。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit13.jpg" alt="" /></p>

<p>すると、<code>tests</code>ディレクトリ以下のテストファイルが自動で起動し、テストが実行される。<br/>
デフォルトのサンプルテストは必ず成功するので、無事、テストが通ればOK。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit14.jpg" alt="" /></p>

<p><code>ExampleTest.php</code>の<code>assertTrue</code>を<code>false</code>にしてみて失敗させてみる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public function testBasicTest()
</span><span class='line'>{
</span><span class='line'>    $this-&gt;assertTrue(false);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ファイルを選択して右クリックすれば、そのファイルのみをテスト実行する事も可能。<br/>
失敗すると以下のようになる。</p>

<p><img src="http://kayakuguri.github.io/images/2017/09/phpunit15.jpg" alt="" /></p>

<p>これで無事、成功と失敗の動作が確認できた。</p>

<h1>参考</h1>

<ul>
<li><a href="https://confluence.jetbrains.com/display/PhpStorm/Running+PHPUnit+tests+over+SSH+on+a+remote+server+with+PhpStorm">Running PHPUnit tests over SSH on a remote server with PhpStorm &ndash; PhpStorm &ndash; Confluence</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Laravel]キューのdelayとsleepオプション]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/09/22/laravel-queue-delay-sleep/"/>
    <updated>2017-09-22T15:05:42+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/09/22/laravel-queue-delay-sleep</id>
    <content type="html"><![CDATA[<p>Laravelにてキューを実行させる際に、delayとsleepオプションの関係がちょっと変だったのでメモ。</p>

<!-- more -->


<h1>sleep</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>--sleep[=SLEEP]      Number of seconds to sleep when no job is available [default: "3"]</span></code></pre></td></tr></table></div></figure>


<p>ジョブがない場合に次のジョブを取得するまでにスリープする秒数の設定。</p>

<h1>delay</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>--delay[=DELAY]      The number of seconds to delay failed jobs [default: "0"]</span></code></pre></td></tr></table></div></figure>


<p>ジョブが失敗した場合に再試行するまでの遅延時間。</p>

<h1>delayとsleep</h1>

<p>両方設定した場合の動作が少し変な気がするのでそれぞれ試してみた。</p>

<table>
<thead>
<tr>
<th></th>
<th align="left"> delay </th>
<th align="left"> sleep </th>
<th align="left"> 失敗時遅延 </th>
<th align="left"> 待機 </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td align="left"> なし </td>
<td align="left"> 30 </td>
<td align="left"> 0 </td>
<td align="left"> 30 </td>
</tr>
<tr>
<td></td>
<td align="left"> 30 </td>
<td align="left"> なし </td>
<td align="left"> 30 </td>
<td align="left"> 0 </td>
</tr>
<tr>
<td></td>
<td align="left"> 5 </td>
<td align="left"> 30 </td>
<td align="left"> 30 </td>
<td align="left"> 30 </td>
</tr>
<tr>
<td></td>
<td align="left"> 30 </td>
<td align="left"> 5 </td>
<td align="left"> 30 </td>
<td align="left"> 5 </td>
</tr>
</tbody>
</table>


<p>実行コマンドは以下。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ php artisan queue:listen --sleep=xx --delay=xx</span></code></pre></td></tr></table></div></figure>


<p>結果は、3行目の<code>delay=5 sleep=30</code>の時だけ意図した動作と違っていた。<br/>
本来ならば<code>delay=5</code>なので失敗時の再試行までの遅延は5秒のはずなのに、sleepに設定している30秒が適用されているようだった。</p>

<h1>結論</h1>

<ul>
<li>delay > sleep の場合は意図通り動作する</li>
<li>delay &lt; sleep の場合はsleepに設定した時間がdelayにも適用される</li>
</ul>


<p>これはバグだろうか…。<br/>
本体のコードをちょっとだけ追ってみたけどよくわからなかったのでもし誰かわかればお願いします。</p>

<p><a href="https://github.com/laravel/framework">laravel/framework</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Laravel] キューのsleepとtimeoutの関係]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/09/22/laravel-queue-sleep-timeout/"/>
    <updated>2017-09-22T12:16:53+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/09/22/laravel-queue-sleep-timeout</id>
    <content type="html"><![CDATA[<p>Laravelのキューを実際に使ってみた際にちょっと変な挙動だと思ったメモ。</p>

<!-- more -->


<h1>sleep</h1>

<p>キューを実行するコマンドのオプションに<code>sleep</code>というものがある。<br/>
コマンドのヘルプの説明は以下。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>--sleep[=SLEEP]      Number of seconds to sleep when no job is available [default: "3"]</span></code></pre></td></tr></table></div></figure>


<p>ジョブがない場合に次のジョブを取得するまでにスリープする秒数の設定、とのこと。<br/>
例えばこれをゼロにすると、常にジョブを取得するためのポーリングが実行され続けるため、ジョブの保存先をキューイングサービスなどにしている場合に、ものすごい数のキュー取得リクエストが飛んでしまう。<br/>
なのでsleepを設定してやれば(ジョブがなくなった時に)、ポーリング間隔を空ける事が出来るので負荷が減ったりする。</p>

<h1>timeout</h1>

<p>処理の<code>timeout</code>オプション。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>--timeout[=TIMEOUT]  The number of seconds a child process can run [default: "60"]</span></code></pre></td></tr></table></div></figure>


<p>処理に指定した時間以上の時間がかかった場合はタイムアウトとする設定。デフォルトは60秒。</p>

<h1>sleepとtimeoutの関係</h1>

<p>sleepの時間を長く設定すると、タイムアウトエラーが発生してしまう。<br/>
例えば以下。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>php artisan queue:listen --sleep=120 --timeout=60</span></code></pre></td></tr></table></div></figure>


<p>というのも、次のキュー取得を実行するまでのスリープ時間もタイムアウトの対象の時間に含まれてしまう、よう。<br/>
なので必ずsleep時間よりもtimeoutの時間を多く設定してやらないといけない。<br/>
上記の場合だと<code>sleep</code>を120秒にしてるので、<code>timeout</code>を(少なくとも)120秒より大きく設定しないといけない。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>php artisan queue:listen --sleep=120 --timeout=125</span></code></pre></td></tr></table></div></figure>


<p>これだと無事、動作する。<br/>
(処理内容に5秒以上かかると合計が125秒を越えてしまうのでタイムアウトになるが）</p>

<h1>疑問</h1>

<p>単にポーリングの待ち時間のはずなのに実行時間のタイムアウトの対象に含まれるのはおかしいのでは？という疑問はやはり出ていたようで、Githubのissueでやりとりがされていた。</p>

<p><a href="https://github.com/laravel/framework/issues/6206">queue:listen&#39;s sleep duration contributing towards timeout · Issue #6206 · laravel/framework</a></p>

<p>内容を読んでいくと、そもそものプロセスの処理に組み込まれてしまっているため、根本的な修正は難しく、timeoutの時間をsleep時間を足して設定してやる、とかしか無理じゃない？みたいなやり取りになっている。</p>

<p>そしてその後、5.1の時にtimeout時間をsleep時間よりも短く設定出来ないようにする制限が組み込まれたようだが、巨大な処理を行う場合にtimeoutをなしにするためにゼロ秒にセットしたいのに出来ない、という意見が出て結局削除されている。</p>

<p>結果、制約も入らず対処もされていないようなので、現状は前述のように、timeout時間をsleep時間より必ず大きく設定してやらないといけない、ということになっているよう。</p>

<h1>余談</h1>

<p>キューのサンプルを作っている時に事象に遭遇したのだけど、そのキューのサンプルはGitHubにあげてる。<br/>
HerokuButtonで起動できるようにしたりしてみたので、よかったらお試しあれ。</p>

<p><a href="https://github.com/k-usk/laravel-queue-sample">https://github.com/k-usk/laravel-queue-sample</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[heroku]PostgresとRedisの環境設定]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/09/21/heroku-postgres-redis/"/>
    <updated>2017-09-21T15:16:32+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/09/21/heroku-postgres-redis</id>
    <content type="html"><![CDATA[<p>LaravelをHerokuで使用する際に、Heroku PostgresとHeroku Redisの接続情報を環境変数から取得する設定のメモ。</p>

<!-- more -->


<h1>概要</h1>

<p>改めて。<br/>
Herokuでは標準のadd-onとして<a href="https://elements.heroku.com/addons/heroku-postgresql">Heroku Postgres</a>と<a href="https://elements.heroku.com/addons/heroku-redis">Heroku Redis</a>が用意されている。<br/>
クレジットカードさえ登録していれば無料で使えるので便利。</p>

<p>この接続情報はアドオンを登録した際に自動的に以下のような変数で登録がされる。</p>

<p><strong>Postgres</strong><br/>
<code>DATABASE_URL</code> = <code>postgres://username:password@hostname.amazonaws.com:5432/database</code></p>

<p><strong>Redis</strong><br/>
<code>REDIS_URL</code> = <code>redis://h:password@hostname.amazonaws.com:port_no</code></p>

<p>各種情報がURL形式で組み込まれているのだが、間違ってもこれを自分でバラしてそれぞれ個別に環境変数に入れる、などとしてはいけない。<br/>
というのも、この接続情報はPostgresやRedisにメンテナンスが入った際に前の接続情報は破棄され、新しい情報が同じ環境変数で設定されるため、<br/>
自前でバラして作ってしまうとその変更した情報に対応できなくなり、接続エラーとなってしまう。</p>

<p>よって、必ず自動でセットされる、<code>DATABASE_URL</code>や<code>REDIS_URL</code>を使うこと。<br/>
これはHerokuを使う際には常識として覚えておくこと。</p>

<h1>取得</h1>

<p>というわけで、それぞれの値を取得したURLからパースしてLaravel用に環境変数にセットする。<br/>
以下のように環境変数があればそれをパースして環境変数としてセットしてやるようにするのがスマートっぽい。<br/>
これだとローカルでは個別に<code>.env</code>ファイルで設定した値を使用してやることが出来る。</p>

<p><code>/config/database.php</code> の冒頭に書く。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//Postgres
</span><span class='line'>if (getenv('DATABASE_URL')) {
</span><span class='line'>    $url = parse_url(getenv('DATABASE_URL'));
</span><span class='line'>    putenv('DB_HOST='.$url['host']);
</span><span class='line'>    putenv('DB_PORT='.$url['port']);
</span><span class='line'>    putenv('DB_DATABASE='.substr($url["path"], 1));
</span><span class='line'>    putenv('DB_USERNAME='.$url["user"]);
</span><span class='line'>    putenv('DB_PASSWORD='.$url['pass']);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>//Redis
</span><span class='line'>if (getenv('REDIS_URL')) {
</span><span class='line'>    $url = parse_url(getenv('REDIS_URL'));
</span><span class='line'>    putenv('REDIS_HOST='.$url['host']);
</span><span class='line'>    putenv('REDIS_PORT='.$url['port']);
</span><span class='line'>    putenv('REDIS_PASSWORD='.$url['pass']);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Visualforce] 必須チェックのエラー文言をカスタマイズする]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/08/22/custom-vf-error/"/>
    <updated>2017-08-22T15:11:17+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/08/22/custom-vf-error</id>
    <content type="html"><![CDATA[<p>前記事の続きで、<code>apex:inputField</code> を使わない場合のバリデーションエラーの表示方法を調べたメモ。<br/>
結局標準の表示では対応してくれないようなので、自前で実装することになった。</p>

<!-- more -->


<p><a href="http://kayakuguri.github.io/blog/2017/08/18/custom-selectlist-req/">前回</a>までで作成した状態はこちら。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;apex:pageBlockSectionItem &gt;
</span><span class='line'>  &lt;apex:outputLabel value="都道府県" for="prefcbx"/&gt;
</span><span class='line'>  &lt;apex:outputPanel styleClass="requiredInput" layout="block"&gt;
</span><span class='line'>      &lt;apex:outputPanel styleClass="requiredBlock" layout="block"/&gt;
</span><span class='line'>      &lt;apex:selectList value="{!pref__c}" id="prefcbx" size="1" required="true"&gt;
</span><span class='line'>          &lt;apex:selectOptions value="{!options}"/&gt;
</span><span class='line'>      &lt;/apex:selectList&gt;
</span><span class='line'>  &lt;/apex:outputPanel&gt;
</span><span class='line'>&lt;/apex:pageBlockSectionItem&gt;</span></code></pre></td></tr></table></div></figure>


<p><img src="http://kayakuguri.github.io/images/2017/08/custom_selectlist02.jpg" alt="" /></p>

<h1>apex:message</h1>

<p>このまま空で送信しても内部的にはエラーとなり送信出来ないのだが、エラーの内容が表示されない。<br/>
そこで、<code>&lt;apex:message&gt;</code>を追加するとエラーは出るようになった。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;apex:message for="prefcbx" styleClass="errorMsg" /&gt;</span></code></pre></td></tr></table></div></figure>


<p>表示は以下。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/custom_error01.jpg" alt="" /></p>

<p>問題点は以下。</p>

<ul>
<li>エラー文言が英語</li>
<li>選択リストのボックスがエラー表示になってない(赤枠がない）</li>
</ul>


<h1>required=true</h1>

<p>この英語のエラーをローカライズして表示させる方法がわからなかった。(<code>lang</code>オプションを設定しても違うようだった）<br/>
なので、apex内で指定したエラー文言を表示させてやることに。</p>

<p><code>&lt;apex:inputField&gt;</code>タグなどに、<code>required=true</code>をつけると必須のチェックを自動で行ってくれるようになるのだが、このチェックは<code>form</code>の<code>action</code>で指定したメソッドなどの送信処理が走る前にチェックがされてしまうよう。<br/>
そのため、入力が空だった場合にはこのエラー文言を表示する、などカスタマイズしようにもすることが出来なかった。</p>

<p>よって、<code>required</code>を外してやる。<br/>
そうすると、必須のエラーも自分で検知してやらないといけなくなる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if(String.isBlank(pref__c)){
</span><span class='line'>  //必須エラー
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>そして<code>required=true</code>を外してしまうと、必須の赤い線が<code>apex:inputField</code>タグで表示されなくなってしまうため、全ての項目の必須表示を自前で実装してやる必要がある。</p>

<h1>addError()</h1>

<p>ちなみに、sObjectに<code>addError()</code>メソッドでエラーを追加してやると追加した文言がエラーとして表示されるようになる。<br/>
ただしこれも上記<code>required=true</code>が入っているとapexの処理が通らないため、<code>required</code>オプションは外しておく。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pref__c.addError('入力して下さい。');</span></code></pre></td></tr></table></div></figure>


<p>上記のように追加すると、以下のように表示がされる。</p>

<blockquote><p><strong>エラー:</strong> 入力して下さい。</p></blockquote>

<h1>apex:outputText</h1>

<p>よって、普通のテキスト表示である、<code>apex:outputText</code>を利用してエラーの有無で出し分けをしてやる。<br/>
さらに、選択リストの部分には、<code>error</code>クラスをつけてやることでエラー表示の赤枠を出してやることが出来るため、エラー時のみ、クラスを<code>error</code>としてやることにする。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public String errorMessage{get;set;}
</span><span class='line'>public String errorClass{get;set;}
</span><span class='line'>
</span><span class='line'>public PageReference save(){
</span><span class='line'>  if(String.isBlank(town.addr1_1name__c)){
</span><span class='line'>      errorMessage = '都道府県を入力して下さい';
</span><span class='line'>      errorClass = 'error';
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>これでようやく以下のように目的通りの表示が出来た。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/custom_error02.jpg" alt="" /></p>

<h1>結果</h1>

<p>最終的に標準と全く同じように必須のエラーを表示してやるように調整した場合、以下のようになった。</p>

<h3>apex</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public with sharing class CusotmSelectList_Sample {
</span><span class='line'>  public CustomObject__c object{get;set;}
</span><span class='line'>  public String errorMessage{get;set;}
</span><span class='line'>  public String errorClass{get;set;}
</span><span class='line'>  
</span><span class='line'>  public CusotmSelectList_Sample(ApexPages.StandardController controller) {
</span><span class='line'>      object = new CustomObject__c();
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  /**
</span><span class='line'>   * カスタム設定から都道府県のリストを取得する
</span><span class='line'>   * @type List&lt;SelectOption&gt;
</span><span class='line'>   */
</span><span class='line'>  public List&lt;SelectOption&gt; getOptions() {
</span><span class='line'>    Map&lt;String, Prefectures__c&gt; prefs = Prefectures__c.getAll();
</span><span class='line'>    List&lt;SelectOption&gt; options = new List&lt;SelectOption&gt;();
</span><span class='line'>    options.add(new SelectOption('', '--なし--'));
</span><span class='line'>    for(String key : prefs.keySet()){
</span><span class='line'>        Prefectures__c pref_obj = prefs.get(key);
</span><span class='line'>        options.add(new SelectOption(pref_obj.Label__c, pref_obj.Label__c));
</span><span class='line'>    }
</span><span class='line'>    return options;
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  public PageReference save(){
</span><span class='line'>      if(String.isBlank(object.pref__c)){
</span><span class='line'>          errorMessage = '&lt;strong&gt;エラー:&lt;/strong&gt; 値を入力してください';
</span><span class='line'>          errorClass = 'error';
</span><span class='line'>          return null;
</span><span class='line'>      }
</span><span class='line'>      
</span><span class='line'>      insert object; //エラーがなければ保存
</span><span class='line'>      return null; //完了画面とかに遷移させる
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>VF Page</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;apex:page showHeader="true" sidebar="true" title="作成" standardController="CustomObject__c" extensions="CusotmSelectList_Sample"&gt;
</span><span class='line'>  &lt;apex:sectionHeader title="レコードの作成" /&gt;
</span><span class='line'>  &lt;apex:form&gt;
</span><span class='line'>      &lt;apex:pageBlock title="" mode="edit"&gt;
</span><span class='line'>      
</span><span class='line'>          &lt;apex:pageBlockButtons&gt;
</span><span class='line'>              &lt;apex:commandButton action="{!save}" value="保存"/&gt;
</span><span class='line'>          &lt;/apex:pageBlockButtons&gt;
</span><span class='line'>          
</span><span class='line'>          &lt;apex:pageBlockSection title="内容" columns="1"&gt;
</span><span class='line'>              &lt;apex:pageBlockSectionItem &gt;
</span><span class='line'>              &lt;apex:outputLabel value="都道府県" for="prefcbx"/&gt;
</span><span class='line'>              &lt;apex:outputPanel styleClass="requiredInput" layout="block"&gt;
</span><span class='line'>                  &lt;apex:outputPanel styleClass="requiredBlock" layout="block"/&gt;
</span><span class='line'>                  &lt;apex:selectList value="{!object.pref__c}" id="prefcbx" size="1" styleClass="{!errorClass}"&gt;
</span><span class='line'>                  &lt;apex:selectOptions value="{!options}"/&gt;
</span><span class='line'>                  &lt;/apex:selectList&gt;
</span><span class='line'>                      &lt;br /&gt;
</span><span class='line'>                      &lt;apex:outputText value="{!errorMessage}" styleClass="errorMsg" rendered="{!LEN(errorMessage)&gt;0}" escape="false"/&gt;
</span><span class='line'>              &lt;/apex:outputPanel&gt;
</span><span class='line'>              &lt;/apex:pageBlockSectionItem&gt;
</span><span class='line'>          &lt;/apex:pageBlockSection&gt;
</span><span class='line'>      
</span><span class='line'>      &lt;/apex:pageBlock&gt;
</span><span class='line'>  &lt;/apex:form&gt;
</span><span class='line'>&lt;/apex:page&gt;</span></code></pre></td></tr></table></div></figure>


<h1>結果</h1>

<p>とりあえずこれで一つの項目で、必須表示〜エラー表示まで実装してやることが出来た。<br/>
ただし、複数項目で実現するためには項目の数だけエラー表示用の変数が必要になるため、クラスにするなど何かしら工夫しないとコードが冗長になりそう。<br/>
また、バリデーション用のコードもヘルパークラスに分けるなどした方がよいかもしれない。</p>

<h1>参考</h1>

<ul>
<li><a href="https://developer.salesforce.com/forums/?id=906F0000000AhwaIAC">&#12456;&#12521;&#12540;&#12513;&#12483;&#12475;&#12540;&#12472;&#12395;&#12388;&#12356;&#12390; &ndash; Salesforce Developer Community</a></li>
<li><a href="https://blog.freedom-man.com/forcecom_apexmessage/">apex:Messageの挙動について調べてみる</a></li>
<li><a href="https://developer.salesforce.com/docs/atlas.ja-jp.pages.meta/pages/pages_compref_message.htm">apex:message</a></li>
<li><a href="https://help.salesforce.com/articleView?id=000006300&amp;language=ja&amp;type=1">Visualforce 上のテキストボックスの下に、カスタムエラーメッセージを表示する方法</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Visualforce] カスタム設定から選択肢を設定し必須表示する]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/08/18/custom-selectlist-req/"/>
    <updated>2017-08-18T18:25:33+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/08/18/custom-selectlist-req</id>
    <content type="html"><![CDATA[<p>Visualforceページにて、選択リストをカスタム設定のリストから取得し、必須の赤いバーを表示させる方法。</p>

<!-- more -->


<p>今回は都道府県の設定をカスタム設定で設定しているとする。</p>

<ul>
<li>カスタム設定のAPI参照名 : <code>Prefectures__c</code></li>
<li>都道府県名を保存している項目名 : <code>Label__c</code></li>
<li>入力先の項目名 : <code>pref__c</code></li>
</ul>


<h1>カスタム設定の取得</h1>

<p>これは別で記事を書いているのでそちらをどうぞ。</p>

<p><a href="http://kayakuguri.github.io/blog/2016/02/01/custom-setting/">カスタム設定を作成して取得してみる &ndash; KayaMemo</a></p>

<p>こんな感じ。<br/>
これでVFページからは、 <code>{!options}</code>で呼び出せる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public List&lt;SelectOption&gt; getOptions() {
</span><span class='line'>  Map&lt;String, Prefectures__c&gt; prefs = Prefectures__c.getAll();
</span><span class='line'>  List&lt;SelectOption&gt; options = new List&lt;SelectOption&gt;();
</span><span class='line'>  options.add(new SelectOption('', '--なし--'));
</span><span class='line'>  for(String key : prefs.keySet()){
</span><span class='line'>      Prefectures__c pref_obj = prefs.get(key);
</span><span class='line'>      options.add(new SelectOption(pref_obj.Label__c, pref_obj.Label__c));
</span><span class='line'>  }
</span><span class='line'>  return options;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>選択リストに任意の値を設定</h1>

<p><code>apex:inputField</code>を使うと楽だが、それではその項目に設定されている選択肢しか表示できない。<br/>
(そもそも選択リスト型でないと選択リストにならない)</p>

<p>よって、<code>apex:selectList</code>を使うと設定可能。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;apex:selectList value="{!pref__c}" size="1" multiselect="false" required="true"&gt;
</span><span class='line'>    &lt;apex:selectOptions value="{!options}"/&gt;
</span><span class='line'>&lt;/apex:selectList&gt;</span></code></pre></td></tr></table></div></figure>


<p>表示は以下のようになる。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/custom_selectlist01.jpg" alt="" /></p>

<h1>必須の表示</h1>

<p>上記画像からわかるように、<code>required="true"</code>を指定しているにも関わらず、SF標準の赤い線が出てくれない。<br/>
これは、<code>apex:inputField</code>を利用している時にしか自動で表示してくれないため、自分で設定してやる必要がある。<br/>
以下のようになる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;apex:pageBlockSectionItem &gt;
</span><span class='line'>  &lt;apex:outputLabel value="都道府県" for="prefcbx"/&gt;
</span><span class='line'>  &lt;apex:outputPanel styleClass="requiredInput" layout="block"&gt;
</span><span class='line'>      &lt;apex:outputPanel styleClass="requiredBlock" layout="block"/&gt;
</span><span class='line'>      &lt;apex:selectList value="{!pref__c}" id="prefcbx" size="1" required="true"&gt;
</span><span class='line'>          &lt;apex:selectOptions value="{!options}"/&gt;
</span><span class='line'>      &lt;/apex:selectList&gt;
</span><span class='line'>  &lt;/apex:outputPanel&gt;
</span><span class='line'>&lt;/apex:pageBlockSectionItem&gt;</span></code></pre></td></tr></table></div></figure>


<p>これで以下のような表示となる。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/custom_selectlist02.jpg" alt="" /></p>

<h1>エラー表示</h1>

<p>さらに同じく空だった場合のエラーの表示も自動で挿入してくれなくなるため、これも自分で表示してやる必要がある。<br/>
が、このエラー表示がかなり難航してるため、解決したら別ポストで。</p>

<p>以下に書きました。<br/>
↓↓<br/>
<a href="http://kayakuguri.github.io/blog/2017/08/22/custom-vf-error/">[Visualforce] 必須チェックのエラー文言をカスタマイズする</a></p>

<h1>参考</h1>

<ul>
<li><a href="http://vaindespair.blogspot.jp/2011/04/blog-post_733.html">memo: Force.com&#12288;&#65306;&#12288;任意の選択リストを作成したい&#65339;Visualforceタグ&#65341;</a></li>
<li><a href="http://kayakuguri.github.io/blog/2016/02/01/custom-setting/">カスタム設定を作成して取得してみる &ndash; KayaMemo</a></li>
<li><a href="http://blog.jeffdouglas.com/2008/11/16/displaying-the-required-red-bar-for-a-control/">Displaying the Required Red Bar for a Control</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Visualforce] テキストエリア入力欄の表示]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/08/17/vf-textarea/"/>
    <updated>2017-08-17T15:16:25+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/08/17/vf-textarea</id>
    <content type="html"><![CDATA[<p>Visualforceページにて、テキストエリアの入力欄を表示する際に、大きさを指定したりした時の表示のされ方などのまとめ。</p>

<!-- more -->


<h2>apex:inputField</h2>

<p>一番基本となる、<code>apex:inputField</code>の場合。<br/>
<code>value</code>で指定した項目の型を読み取って自動で入力フォームのタイプを変更してくれるので、普通はこちらを使っておけばよい。</p>

<p>ただし、テキストエリア項目の場合は以下のように入力欄がすごく小さい。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;apex:inputField value="{!項目名}" required="true" label="inputFieldサンプル" /&gt;</span></code></pre></td></tr></table></div></figure>


<p><img src="http://kayakuguri.github.io/images/2017/08/vf_textarea01.jpg" alt="" /></p>

<p>なので、サイズを調整したいが、<code>apex:inputField</code>には<code>rows</code>や<code>cols</code>などのオプションがない。<br/>
よって、スタイスを直接書いてやるしかなさそう。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;apex:inputField value="{!項目名}" required="true" style="width:315px; height:70px;" label="inputFieldサンプル サイズ変更" /&gt;</span></code></pre></td></tr></table></div></figure>


<p><img src="http://kayakuguri.github.io/images/2017/08/vf_textarea02.jpg" alt="" /></p>

<p>これで、サイズを任意に変更しつつ必須表示にも対応。</p>

<h3>エラー</h3>

<p><code>apex:inputField</code>を使った場合はそのままエラーの表示にも対応している。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/vf_textarea06.jpg" alt="" /></p>

<h2>apex:inputtextArea</h2>

<p><code>apex:inputtextArea</code>を利用すると、<code>rows</code> <code>cols</code>でのサイズ指定が可能。<br/>
<code>apex:outputlabel</code>も使うと標準の表示を同じようにラベルを配置してやれる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;apex:pageblocksectionItem&gt;
</span><span class='line'>  &lt;apex:outputlabel value = "outputlabelサンプル"/&gt;
</span><span class='line'>  &lt;apex:inputtextArea value = "{!項目名}" cols = "50" rows = "5" required="true" /&gt;
</span><span class='line'>&lt;/apex:pageblocksectionItem&gt;</span></code></pre></td></tr></table></div></figure>


<p><img src="http://kayakuguri.github.io/images/2017/08/vf_textarea03.jpg" alt="" /></p>

<p>しかし、この場合だと <code>required="true"</code> を指定していても赤い線が表示されない。<br/>
その赤い線を再現してやるには、divでクラスをつけて構造を再現してやる必要があるよう。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;apex:pageBlockSectionItem&gt;
</span><span class='line'>  &lt;apex:outputlabel value = "outputlabelサンプル 必須再現"/&gt;
</span><span class='line'>  &lt;apex:outputPanel&gt;
</span><span class='line'>      &lt;div class="requiredInput"&gt;
</span><span class='line'>      &lt;div class="requiredBlock"&gt;&lt;/div&gt;
</span><span class='line'>      &lt;apex:inputtextArea value="{!項目名}" cols = "50" rows = "5" required="true" /&gt;
</span><span class='line'>  &lt;/div&gt;
</span><span class='line'>  &lt;/apex:outputPanel&gt;
</span><span class='line'>&lt;/apex:pageBlockSectionItem&gt;</span></code></pre></td></tr></table></div></figure>


<p><img src="http://kayakuguri.github.io/images/2017/08/vf_textarea04.jpg" alt="" /></p>

<p>これで任意のサイズを指定しつつ、必須表示も出来るようになった。</p>

<p>これらを並べてやると以下のような感じ。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/vf_textarea05.jpg" alt="" /></p>

<h3>エラー</h3>

<p>エラー表示はそのままだと対応していないため、以下のような方法で自前で実装してやる必要がある。</p>

<p><a href="https://developer.salesforce.com/forums/?id=906F0000000AhwaIAC">&#12456;&#12521;&#12540;&#12513;&#12483;&#12475;&#12540;&#12472;&#12395;&#12388;&#12356;&#12390; &ndash; Salesforce Developer Community</a></p>

<h2>参考</h2>

<ul>
<li><a href="https://developer.salesforce.com/forums/?id=906F000000095xFIAQ">How do I alter dimensions of inputField Text and TextArea fields ? &ndash; Salesforce Developer Community</a></li>
<li><a href="https://salesforce.stackexchange.com/questions/5462/required-field-mark-red-vertical-bar-not-coming">visualforce &ndash; Required field mark (Red Vertical Bar) not coming &ndash; Salesforce Stack Exchange</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[カスタムドメイン取得とLet's Encrypt証明書とHeroku SSLと]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/08/04/customdomain-letsencrypt-herokussl/"/>
    <updated>2017-08-04T17:06:28+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/08/04/customdomain-letsencrypt-herokussl</id>
    <content type="html"><![CDATA[<p>Herokuへの証明書アップロード手順の確認のために、カスタムドメイン・証明書の取得から試してみた。<br/>
長い記事になりますが、備忘録として。</p>

<!-- more -->


<h1>ドメインの取得</h1>

<p>無料で独自ドメインを取得出来るという、 <a href="http://www.freenom.com/ja/index.html">freenom</a>を使用する。<br/>
(やはり無料だけあって色々とデメリットがあげられたりしているので、ご利用は自己責任で)<br/>
取得できるドメインは5種類で、 <code>.tk/.ml/.ga/.cf/.gq</code> となっている。</p>

<p>詳しい登録方法などは以下を参考にさせてもらいました。</p>

<ul>
<li><a href="http://qiita.com/teekay/items/135dc67e39f24997019e">無料のドメインを取得する（2016年10月） &ndash; Qiita</a></li>
</ul>


<p>今回は <code>.tk</code> のドメインで取得した。<br/>
ちなみに、<code>.tk</code>のドメインは90日間で25アクセス以下だった場合には登録が削除されるらしいので運用の際は注意。</p>

<p>以下のドメインで取得してみた。(もうドメイン登録はキャンセル済み）</p>

<blockquote><p>ssl-sni-test.tk</p></blockquote>

<p>ユーザー登録はメールアドレスからの登録にしたが、住所や名前などは必須となっていた。<br/>
以下が必須だった項目。</p>

<ul>
<li>first name</li>
<li>last name</li>
<li>address1</li>
<li>city</li>
<li>state</li>
<li>postcode</li>
<li>phone number</li>
<li>password</li>
</ul>


<p>登録すれば同時にドメインの申請も完了。</p>

<h2>ネームサーバとDNS</h2>

<p>freenomには無料で利用できるDNSサーバが用意されているのでそれを利用する。</p>

<p>上部メニューから <code>Services -&gt; My Domains</code> を選択。<br/>
編集したいドメインの、 <code>Manage Domain</code>をクリック。</p>

<p>タブメニューの <code>Management Tools -&gt; Nameservers</code>を選択。<br/>
<code>Use default nameservers</code>を選択して、<code>Change Nameservers</code>をクリック。<br/>
これで、freenomのネームサーバを使う設定に変更できた。<br/>
（デフォルトではfreenomのネームサーバを使うように設定されていないため、DNSの設定が出来なかった。）</p>

<p>あとは、タブメニューの <code>Manage Freenom DNS</code>を選択。<br/>
ここで、DNSの設定が可能となる。</p>

<h1>証明書の取得</h1>

<p>証明書は無料で発行出来る、 <code>Let</code>s Encrypt`を利用する。<br/>
証明書の発行には、ブラウザ上で発行出来るサービスがあるのでそちらを利用させてもらう。<br/>
以下に作者さんの詳しい説明があるので、そちらから。</p>

<ul>
<li><a href="http://qiita.com/tappie/items/76881fdf7996c57a105a">Let&#39;s Encrypt の証明書をブラウザ上で簡単取得 (dns-01 / ECDSA もあるよ) &ndash; Qiita</a></li>
</ul>


<p>基本、そのまま進めて問題ないが、１点だけ、秘密鍵はブラウザ上では作らずにローカルPC上で作成したものをアップした方がよさそう。<br/>
ブラウザ上で作ったものをHerokuにアップするとパスフレーズを解除しろ、と言われ、パスフレーズを解除しようとコマンドを入れるとエラーが出たりしたため、最初からパスフレーズがかかっていないものを作成し、アップロードした方が確実と思われる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl genrsa 2048 &gt; key.pem</span></code></pre></td></tr></table></div></figure>


<p>ドメインの所有証明は、<code>dns-01</code>の方法を使用した。<br/>
取得したチャレンジトークンをTXTレコードとしてDNSに登録する。</p>

<p>登録例</p>

<table>
<thead>
<tr>
<th></th>
<th align="left"> Name </th>
<th align="left"> Type </th>
<th align="left"> TTL </th>
<th align="left"> Target </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td align="left"> <code>_acme-challenge.ssl-sni-test.tk.</code> </td>
<td align="left"> TXT </td>
<td align="left"> 14440 </td>
<td align="left"> <code>"L9Dlzt3Kzfu2mLYbmW2RTUdEzNBuNPiyyBt6yQyEjKk"</code> |</td>
</tr>
</tbody>
</table>


<p>結構すぐに反映された。<br/>
あとは証明書を発行するのみ。</p>

<h1>Herokuへアップロード</h1>

<p>Herokuのアプリに証明書を適用させるには2種類の方法がある。</p>

<ul>
<li><code>SSL Endpoint</code> : SSLアドオンを利用した方法 ($20/month)

<ul>
<li>Typeは <code>sni</code></li>
</ul>
</li>
<li><code>Heroku SSL</code> : Heroku標準の機能 (無料)

<ul>
<li>Typeは <code>endpoint</code></li>
</ul>
</li>
</ul>


<p><code>SSL Endpoint</code>は従来からの方法で、2016年末ごろに<code>Heroku SSL</code>が追加された。<br/>
なので、今後追加する場合には<code>Heroku SSL</code>を利用する方がよい。</p>

<p>ただし、<code>Heroku SSL</code>はFree Dynoで利用しているアプリには使用出来ないので注意。<br/>
今回は <code>Heroku SSL</code>を利用する。</p>

<h2>アップロード方法</h2>

<p>アップロード方法は管理画面からGUI操作で行うか、Heroku CLI経由でコマンドラインから行うかの2種類がある。</p>

<h3>管理画面からアップロードする</h3>

<p><code>Setting</code>から、<code>Domains and certificates</code>セクションにある、<code>Configure SSL</code>をクリック。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/ssl01.jpg" alt="" /></p>

<p>更新方法を聞かれるので、今回は<code>Manually</code>を選択。<br/>
<code>Automatically</code>はLet&rsquo;s Encryptの場合にのみ使える自動更新のオプションで、今回はLet&rsquo;s Enctyptなので利用出来るのだが、普通はマニュアルになるため今回もマニュアルにした。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/ssl02.jpg" alt="" /></p>

<p>アップロードするウインドウが表示されるので、ファイルをドラッグ。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/ssl03.jpg" alt="" /></p>

<p>アップするものは以下。</p>

<ul>
<li>証明書 (+中間証明書)</li>
<li>秘密鍵</li>
</ul>


<p>中間証明書は、Let&rsquo;s Encryptの場合だけなのかは不明だが、今回はなしでもアップすることが出来た。<br/>
通常は必要だと思われる（証明書発行会社のページには一緒にアップして下さい、とある）ので末尾に追加しておく。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/ssl04.jpg" alt="" /></p>

<p>無事、アップされると以下のようになる。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/ssl06.jpg" alt="" /></p>

<h3>コマンドからのアップロード</h3>

<p><code>certs:add</code>でアップ可能。コマンドのヘルプは以下。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku certs:add -h
</span><span class='line'>Usage: heroku certs:add CRT KEY [flags]
</span><span class='line'>
</span><span class='line'>add an SSL certificate to an app
</span><span class='line'>
</span><span class='line'>Flags:
</span><span class='line'> -a, --app     (required) app to run command against
</span><span class='line'> -r, --remote  git remote of app to use
</span><span class='line'> --bypass      bypass the trust chain completion step
</span><span class='line'> --domains     domains to create after certificate upload
</span><span class='line'> --type        type to create, either 'sni' or 'endpoint'
</span><span class='line'>
</span><span class='line'>Note: certificates with PEM encoding are also valid
</span><span class='line'>
</span><span class='line'>Example:
</span><span class='line'>
</span><span class='line'>    $ heroku certs:add example.com.crt example.com.key
</span><span class='line'>
</span><span class='line'>Example (Certificate Intermediary):
</span><span class='line'>
</span><span class='line'>     $ heroku certs:add intermediary.crt example.com.crt example.com.key</span></code></pre></td></tr></table></div></figure>


<p>アップする。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku certs:add ssl-sni-test-cert.pem ssl-sni-test-server-nopass.key -a sni-test
</span><span class='line'>Resolving trust chain... done
</span><span class='line'>Adding SSL certificate to ⬢ sni-test... done
</span><span class='line'>Certificate details:
</span><span class='line'>Common Name(s): ssl-sni-test.tk
</span><span class='line'>Expires At:     2017-11-02 02:12 UTC
</span><span class='line'>Issuer:         /C=US/O=Let's Encrypt/CN=Let's Encrypt Authority X3
</span><span class='line'>Starts At:      2017-08-04 02:12 UTC
</span><span class='line'>Subject:        /CN=ssl-sni-test.tk
</span><span class='line'>SSL certificate is verified by a root authority.
</span><span class='line'>? Select domains you would like to add
</span><span class='line'>
</span><span class='line'>=== Your certificate has been added successfully.  Add a custom domain to your app by running ⬢ heroku domains:add &lt;yourdomain.com&gt;</span></code></pre></td></tr></table></div></figure>


<p>途中、ドメインの選択する箇所があったが、一つしかないしそのままエンターでいけた。</p>

<p>コマンドからアップ状況を確認する。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku certs -a sni-test
</span><span class='line'>Name              Common Name(s)   Expires               Trusted  Type
</span><span class='line'>────────────────  ───────────────  ────────────────────  ───────  ────
</span><span class='line'>pteranodon-48202  ssl-sni-test.tk  2017-11-02 02:12 UTC  True     SNI</span></code></pre></td></tr></table></div></figure>


<h1>ドメインの設定</h1>

<p>Herokuへのドメイン追加、と、DNSの設定、の２つが必要。</p>

<h2>Herokuへのドメイン追加</h2>

<p>証明書をアップした時と同じく、<code>Setting</code>画面から追加する。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/ssl07.jpg" alt="" /></p>

<p>追加したいドメインを登録。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/ssl08.jpg" alt="" /></p>

<p>登録すると以下のようになる。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/ssl09.jpg" alt="" /></p>

<p>もちろん、コマンドからも登録可能。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku domains:add ssl-sni-test.tk -a sni-test
</span><span class='line'>Adding ssl-sni-test.tk to ⬢ sni-test... done
</span><span class='line'> ▸    Configure your app's DNS provider to point to the DNS Target ssl-sni-test.tk.herokudns.com.
</span><span class='line'> ▸    For help, see https://devcenter.heroku.com/articles/custom-domains
</span><span class='line'>
</span><span class='line'>The domain ssl-sni-test.tk has been enqueued for addition
</span><span class='line'> ▸    Run heroku domains:wait 'ssl-sni-test.tk' to wait for completion</span></code></pre></td></tr></table></div></figure>


<p>コマンドから確認すると以下のようになる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku domains -a sni-test
</span><span class='line'>=== sni-test Heroku Domain
</span><span class='line'>sni-test.herokuapp.com
</span><span class='line'>
</span><span class='line'>=== sni-test Custom Domains
</span><span class='line'>Domain Name      DNS Target
</span><span class='line'>───────────────  ─────────────────────────────
</span><span class='line'>ssl-sni-test.tk  ssl-sni-test.tk.herokudns.com</span></code></pre></td></tr></table></div></figure>


<h2>DNSの設定</h2>

<p>freenomからDNSの設定を行う。<br/>
Heroku側のドメイン追加で取得したDNS TargetをCNAMEとして登録する。以下のような形で追加した。</p>

<table>
<thead>
<tr>
<th></th>
<th align="left"> Name </th>
<th align="left"> Type </th>
<th align="left"> TTL </th>
<th align="left"> Target </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td align="left">  </td>
<td align="left"> CNAME </td>
<td align="left"> 14440 </td>
<td align="left"> <code>ssl-sni-test.tk.herokudns.com</code> |</td>
</tr>
</tbody>
</table>


<h1>アクセス</h1>

<p><code>https</code>でアクセスすると、無事、アクセス出来た。<br/>
SSLもLet&rsquo;s Encryptでちゃんと反映されていた。</p>

<p><img src="http://kayakuguri.github.io/images/2017/08/ssl10.jpg" alt="" /></p>

<h1>2つの証明書と2つのドメイン</h1>

<p>ここからは応用検証。<br/>
一つのHerokuアプリに2つのドメインを適用させ、それぞれに別々の証明書を適用させてみる。</p>

<h2>サブドメインの証明書</h2>

<p>先ほどと同じようにサブドメインの証明書を取得した。以下で取得する。</p>

<blockquote><p>add.ssl-sni-test.tk</p></blockquote>

<p>チャレンジトークンも変わるので、DNSレコードに2つ目のTXTレコードを追加する。</p>

<h2>Herokuへアップ</h2>

<p>管理画面から同じようにアップしてみたが、すでにアップされているものを置き換える事になるようで、複数の証明書をアップすることは出来なかった。<br/>
次にコマンドから追加してみるも、以下のようにエラーが出た。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku certs:add cert.pem server.key -a sni-test
</span><span class='line'>Resolving trust chain... done
</span><span class='line'>Adding SSL certificate to ⬢ sni-test... !
</span><span class='line'> ▸    Only one SNI endpoint is allowed per app (try certs:update instead).</span></code></pre></td></tr></table></div></figure>


<p>どうやら証明書は一つしかアップ出来ないよう。<br/>
しかし、<code>Only one SNI endpoint</code>とあるように、<code>sni</code>のタイプには証明書は一つしかアップできない、とのことのよう。</p>

<h3>SSL Endpoint</h3>

<p>というわけで、SSL Endpointのアドオンを追加し、試してみた。<br/>
アドオンを追加する。(有料なので注意)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku addons:create ssl:endpoint</span></code></pre></td></tr></table></div></figure>


<p>証明書をアップする。その際、typeに<code>endpoint</code>を指定する。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku certs:add cert.pem server.key --type endpoint -a sni-test
</span><span class='line'>Resolving trust chain... done
</span><span class='line'>Adding SSL certificate to ⬢ sni-test... done
</span><span class='line'>⬢ sni-test now served by kanagawa-69051.herokussl.com
</span><span class='line'>Certificate details:
</span><span class='line'>Common Name(s): add.ssl-sni-test.tk
</span><span class='line'>Expires At:     2017-11-02 02:49 UTC
</span><span class='line'>Issuer:         /C=US/O=Let's Encrypt/CN=Let's Encrypt Authority X3
</span><span class='line'>Starts At:      2017-08-04 02:49 UTC
</span><span class='line'>Subject:        /CN=add.ssl-sni-test.tk
</span><span class='line'>SSL certificate is verified by a root authority.
</span><span class='line'>? Select domains you would like to add
</span><span class='line'>
</span><span class='line'>=== Your certificate has been added successfully.  Update your application's DNS settings as follows
</span><span class='line'>Domain           Record Type  DNS Target
</span><span class='line'>───────────────  ───────────  ─────────────────────────────
</span><span class='line'>ssl-sni-test.tk  ALIAS/ANAME  ssl-sni-test.tk.herokudns.com</span></code></pre></td></tr></table></div></figure>


<p>やはりtypeが違うのでアップすることが出来た。<br/>
証明書のアップ状況を確認してみる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku certs -a sni-test
</span><span class='line'>Name                 Endpoint                      Common Name(s)       Expires               Trusted  Type
</span><span class='line'>───────────────────  ────────────────────────────  ───────────────────  ────────────────────  ───────  ────────
</span><span class='line'>kanagawa-69051       kanagawa-69051.herokussl.com  add.ssl-sni-test.tk  2017-11-02 02:49 UTC  True     Endpoint
</span><span class='line'>corythosaurus-87918  (Not applicable for SNI)      ssl-sni-test.tk      2017-11-02 02:12 UTC  True     SNI</span></code></pre></td></tr></table></div></figure>


<h2>ドメインの追加</h2>

<p>同じく、Herokuへドメインを追加する。<br/>
登録するTarget Nameは、<code>herokudns.com</code>のものでもよいし、<code>kanagawa-69051.herokussl.com</code>のSSL Endpointで設定されているものでもどちらでもよい。</p>

<p>DNSには以下のように追加した。</p>

<table>
<thead>
<tr>
<th></th>
<th align="left"> Name </th>
<th align="left"> Type </th>
<th align="left"> TTL </th>
<th align="left"> Target </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td align="left"> <code>add</code> </td>
<td align="left"> CNAME </td>
<td align="left"> 14440 </td>
<td align="left"> <code>kanagawa-69051.herokussl.com</code> |</td>
</tr>
</tbody>
</table>


<h2>アクセス</h2>

<p>これで無事、 <code>ssl-sni-test.tk</code> と、 <code>add.ssl-sni-test.tk</code> の両方へアクセス出来るようになった。<br/>
さらに、どちらにも別々の証明書を適用させる事が出来た。</p>

<h1>感想</h1>

<p>無料ドメインと無料証明書はかなり便利そう。ドメインの方は運用に不安が残るが、全く無料で独自ドメインのHTTPSのサイトが持てるというのはちょっと驚き。(Herokuは無料では不可能）</p>

<p>Herokuの場合はアプリを気軽に作る事が出来るため、一つのサーバ(アプリ)での運用、というのはあまりすることがないと思われる。<br/>
そのため、<code>sni</code> <code>endpoint</code> それぞれのタイプで一つしか証明書がアップ出来ないようになっているのだと思う。それだったらアプリを分ければいいよ、との考え方だと思うので、複数アップロードの出番はまずないと思われる。</p>

<h1>参考</h1>

<ul>
<li><a href="http://qiita.com/teekay/items/135dc67e39f24997019e">無料のドメインを取得する（2016年10月） &ndash; Qiita</a></li>
<li><a href="http://qiita.com/tappie/items/76881fdf7996c57a105a">Let&#39;s Encrypt の証明書をブラウザ上で簡単取得 (dns-01 / ECDSA もあるよ) &ndash; Qiita</a></li>
<li><a href="https://zenlogic.jp/user-support/knowledge/ssl/sni.html">SSL基礎知識 1つのサーバーで複数の証明書が使える、SNIって？｜Zenlogic &ndash; ファーストサーバ株式会社</a></li>
<li><a href="https://devcenter.heroku.com/articles/ssl">Heroku SSL | Heroku Dev Center</a></li>
<li><a href="https://devcenter.heroku.com/articles/ssl-endpoint">SSL Endpoint | Heroku Dev Center</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Pardot APIでの認証と作成]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/07/31/pardot-api/"/>
    <updated>2017-07-31T19:04:08+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/07/31/pardot-api</id>
    <content type="html"><![CDATA[<p>Pardot APIを使用する事になったのでAPI送信方法のメモ。</p>

<!-- more -->


<h1>バージョン</h1>

<p>APIのバージョンは、3と4が稼働中のよう。<br/>
使い分けは以下との事。</p>

<blockquote><p>同じメールアドレスで複数のプロスペクトを作成できないアカウントの場合、バージョン 3 を参照してください。<br/>
同じメールアドレスで複数のプロスペクトを作成できるアカウントの場合、バージョン 4 を参照してください。<br/>
<a href="http://help.pardot.com/customer/ja/portal/articles/2128635-pardot-api-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88?b_id=11139">Pardot API を使用する場合</a></p></blockquote>

<h1>Authentication</h1>

<p><a href="http://developer.pardot.com/#authentication">http://developer.pardot.com/#authentication</a></p>

<p>送信パラメータは、ログイン用の <code>email</code> と <code>password</code> と、そのユーザの <code>user_key</code> 。<br/>
<code>user_key</code> は、 設定画面の MY PROFILEから確認出来る。</p>

<p>curlから送信した内容は以下。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl --request POST \
</span><span class='line'>--url https://pi.pardot.com/api/login/version/4 \
</span><span class='line'>--header 'content-type: multipart/form-data' \
</span><span class='line'>--form 'email=test@example.com' \
</span><span class='line'>--form 'password=your_password' \
</span><span class='line'>--form user_key=your_user_key</span></code></pre></td></tr></table></div></figure>


<p>レスポンスは以下のようにXMLで返ってくる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
</span><span class='line'>&lt;rsp stat="ok" version="1.0"&gt;
</span><span class='line'>  &lt;api_key&gt;you_api_key_here&lt;/api_key&gt;
</span><span class='line'>  &lt;version&gt;4&lt;/version&gt;
</span><span class='line'>&lt;/rsp&gt;</span></code></pre></td></tr></table></div></figure>


<h1>Create</h1>

<p><a href="http://developer.pardot.com/kb/api-version-4/prospects/#creating-prospects">http://developer.pardot.com/kb/api-version-4/prospects/#creating-prospects</a></p>

<p>Prospectを作成するには以下のエンドポイントにPOSTで送信する。<br/>
(APIの送信は認証も含めて全てPOSTで送信するよう。)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>POST : /api/prospect/version/4/do/create/email/</span></code></pre></td></tr></table></div></figure>


<p>パラメータの必須項目は以下。</p>

<ul>
<li><code>email</code> : 作成するプロスペクトのメールアドレス</li>
<li><code>api_key</code> : 認証で取得したキー</li>
<li><code>user_key</code> : ユーザのキー</li>
</ul>


<p>emailはパラメータにつけずに、エンドポイントの最後につけてしまってもよいよう。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/api/prospect/version/4/do/create/email/&lt;email&gt;</span></code></pre></td></tr></table></div></figure>


<p>curlで送信した内容は以下。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl --request POST \
</span><span class='line'>  --url https://pi.pardot.com/api/prospect/version/4/do/create/email/ \
</span><span class='line'>  --header 'content-type: multipart/form-data' \
</span><span class='line'>  --form api_key=your_api_key \
</span><span class='line'>  --form user_key=your_user_key \
</span><span class='line'>  --form email=create_email@example.com</span></code></pre></td></tr></table></div></figure>


<p>返却されるXMLは以下。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
</span><span class='line'>&lt;rsp stat="ok" version="1.0"&gt;
</span><span class='line'>  &lt;prospect&gt;
</span><span class='line'>      &lt;id&gt;xxxxxxxx&lt;/id&gt;
</span><span class='line'>      &lt;campaign_id&gt;xxx&lt;/campaign_id&gt;
</span><span class='line'>      &lt;salutation/&gt;
</span><span class='line'>      &lt;first_name/&gt;
</span><span class='line'>      &lt;last_name/&gt;
</span><span class='line'>      &lt;email&gt;create_email@example.com&lt;/email&gt;
</span><span class='line'>      &lt;password/&gt;
</span><span class='line'>      &lt;company/&gt;
</span><span class='line'>      &lt;website/&gt;
</span><span class='line'>      &lt;job_title/&gt;
</span><span class='line'>      &lt;department/&gt;
</span><span class='line'>      &lt;country/&gt;
</span><span class='line'>      &lt;address_one/&gt;
</span><span class='line'>      &lt;address_two/&gt;
</span><span class='line'>      &lt;city/&gt;
</span><span class='line'>      &lt;state/&gt;
</span><span class='line'>      &lt;territory/&gt;
</span><span class='line'>      &lt;zip/&gt;
</span><span class='line'>      &lt;phone/&gt;
</span><span class='line'>      &lt;fax/&gt;
</span><span class='line'>      &lt;source/&gt;
</span><span class='line'>      &lt;annual_revenue/&gt;
</span><span class='line'>      &lt;employees/&gt;
</span><span class='line'>      &lt;industry/&gt;
</span><span class='line'>      &lt;years_in_business/&gt;
</span><span class='line'>      &lt;comments/&gt;
</span><span class='line'>      &lt;notes/&gt;
</span><span class='line'>      &lt;score&gt;0&lt;/score&gt;
</span><span class='line'>      &lt;grade/&gt;
</span><span class='line'>      &lt;last_activity_at/&gt;
</span><span class='line'>      &lt;recent_interaction&gt;Never active&lt;/recent_interaction&gt;
</span><span class='line'>      &lt;crm_lead_fid/&gt;
</span><span class='line'>      &lt;crm_contact_fid/&gt;
</span><span class='line'>      &lt;crm_owner_fid/&gt;
</span><span class='line'>      &lt;crm_account_fid/&gt;
</span><span class='line'>      &lt;salesforce_fid/&gt;
</span><span class='line'>      &lt;crm_last_sync/&gt;
</span><span class='line'>      &lt;crm_url/&gt;
</span><span class='line'>      &lt;is_do_not_email&gt;&lt;/is_do_not_email&gt;
</span><span class='line'>      &lt;is_do_not_call&gt;&lt;/is_do_not_call&gt;
</span><span class='line'>      &lt;opted_out&gt;&lt;/opted_out&gt;
</span><span class='line'>      &lt;is_reviewed&gt;&lt;/is_reviewed&gt;
</span><span class='line'>      &lt;is_starred&gt;&lt;/is_starred&gt;
</span><span class='line'>      &lt;created_at&gt;2017-07-31 18:49:34&lt;/created_at&gt;
</span><span class='line'>      &lt;updated_at&gt;2017-07-31 18:49:34&lt;/updated_at&gt;
</span><span class='line'>      &lt;campaign&gt;
</span><span class='line'>          &lt;id&gt;xxx&lt;/id&gt;
</span><span class='line'>          &lt;name&gt;Website Tracking&lt;/name&gt;
</span><span class='line'>      &lt;/campaign&gt;
</span><span class='line'>      &lt;profile&gt;
</span><span class='line'>          &lt;id&gt;xxx&lt;/id&gt;
</span><span class='line'>          &lt;name&gt;Default&lt;/name&gt;
</span><span class='line'>          &lt;profile_criteria&gt;
</span><span class='line'>              &lt;id&gt;xxx&lt;/id&gt;
</span><span class='line'>              &lt;name&gt;Company Size&lt;/name&gt;
</span><span class='line'>              &lt;matches&gt;Unknown&lt;/matches&gt;
</span><span class='line'>          &lt;/profile_criteria&gt;
</span><span class='line'>          &lt;profile_criteria&gt;
</span><span class='line'>              &lt;id&gt;xxx&lt;/id&gt;
</span><span class='line'>              &lt;name&gt;Industry&lt;/name&gt;
</span><span class='line'>              &lt;matches&gt;Unknown&lt;/matches&gt;
</span><span class='line'>          &lt;/profile_criteria&gt;
</span><span class='line'>          &lt;profile_criteria&gt;
</span><span class='line'>              &lt;id&gt;xxx&lt;/id&gt;
</span><span class='line'>              &lt;name&gt;Location&lt;/name&gt;
</span><span class='line'>              &lt;matches&gt;Unknown&lt;/matches&gt;
</span><span class='line'>          &lt;/profile_criteria&gt;
</span><span class='line'>          &lt;profile_criteria&gt;
</span><span class='line'>              &lt;id&gt;xxx&lt;/id&gt;
</span><span class='line'>              &lt;name&gt;Job Title&lt;/name&gt;
</span><span class='line'>              &lt;matches&gt;Unknown&lt;/matches&gt;
</span><span class='line'>          &lt;/profile_criteria&gt;
</span><span class='line'>          &lt;profile_criteria&gt;
</span><span class='line'>              &lt;id&gt;xxx&lt;/id&gt;
</span><span class='line'>              &lt;name&gt;Department&lt;/name&gt;
</span><span class='line'>              &lt;matches&gt;Unknown&lt;/matches&gt;
</span><span class='line'>          &lt;/profile_criteria&gt;
</span><span class='line'>      &lt;/profile&gt;
</span><span class='line'>      &lt;visitors/&gt;
</span><span class='line'>      &lt;visitor_activities/&gt;
</span><span class='line'>      &lt;lists/&gt;
</span><span class='line'>  &lt;/prospect&gt;
</span><span class='line'>&lt;/rsp&gt;</span></code></pre></td></tr></table></div></figure>


<p>環境によってフィールドとかの増減があるのかも。<br/>
作成されたプロスペクトは、IDからURLでアクセス出来る。</p>

<blockquote><p><a href="https://pi.pardot.com/prospect/read/id/xxxxxxxx">https://pi.pardot.com/prospect/read/id/xxxxxxxx</a></p></blockquote>

<p>Prospectの全標準項目は、以下のよう。<br/>
<a href="http://developer.pardot.com/kb/object-field-references/#prospect">http://developer.pardot.com/kb/object-field-references/#prospect</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LaravelでCORSに対応する]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/06/19/larave-cors/"/>
    <updated>2017-06-19T11:45:01+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/06/19/larave-cors</id>
    <content type="html"><![CDATA[<p>Laravelでクロスオリジン、CORS (Cross-Origin Resource Sharing) に対応する方法。<br/>
対応用のLaravelライブラリがあるのでそれを利用する。</p>

<!-- more -->


<p>JSからajaxなどで通信する場合、ドメインをまたいだ通信の場合(クロスオリジン)はセキュリティ上禁止されている。<br/>
ので、それを通信を受けるサーバーサイドで許可してやる。</p>

<h1>barryvdh/laravel-cors</h1>

<p>ライブラリがあるので、そちらを利用する。</p>

<h2>インストール</h2>

<p>Composerで導入する。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ composer require barryvdh/laravel-cors</span></code></pre></td></tr></table></div></figure>


<h2>セットアップ</h2>

<p><code>config/app.php</code>の <code>providers</code>の配列に以下を追加。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Barryvdh\Cors\ServiceProvider::class,</span></code></pre></td></tr></table></div></figure>


<p><code>app/Http/Kernel.php</code> の <code>$middleware</code> に以下を追加。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>protected $middleware = [
</span><span class='line'>    // ...
</span><span class='line'>    \Barryvdh\Cors\HandleCors::class,
</span><span class='line'>];</span></code></pre></td></tr></table></div></figure>


<p>上記は全体に対応する場合。<br/>
もし、APIのみに許可したい場合は以下のようにする。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>protected $middlewareGroups = [
</span><span class='line'>    'web' =&gt; [
</span><span class='line'>       // ...
</span><span class='line'>    ],
</span><span class='line'>
</span><span class='line'>    'api' =&gt; [
</span><span class='line'>        // ...
</span><span class='line'>        \Barryvdh\Cors\HandleCors::class,
</span><span class='line'>    ],
</span><span class='line'>];</span></code></pre></td></tr></table></div></figure>


<h2>設定ファイル</h2>

<p>設定ファイルを以下のコマンドで作成する。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ php artisan vendor:publish --provider="Barryvdh\Cors\ServiceProvider"</span></code></pre></td></tr></table></div></figure>


<p>以下の内容で作成される。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>return [
</span><span class='line'>     /*
</span><span class='line'>     |--------------------------------------------------------------------------
</span><span class='line'>     | Laravel CORS
</span><span class='line'>     |--------------------------------------------------------------------------
</span><span class='line'>     |
</span><span class='line'>     | allowedOrigins, allowedHeaders and allowedMethods can be set to array('*')
</span><span class='line'>     | to accept any value.
</span><span class='line'>     |
</span><span class='line'>     */
</span><span class='line'>    'supportsCredentials' =&gt; false,
</span><span class='line'>    'allowedOrigins' =&gt; ['*'],
</span><span class='line'>    'allowedHeaders' =&gt; ['Content-Type', 'X-Requested-With'],
</span><span class='line'>    'allowedMethods' =&gt; ['*'], // ex: ['GET', 'POST', 'PUT',  'DELETE']
</span><span class='line'>    'exposedHeaders' =&gt; [],
</span><span class='line'>    'maxAge' =&gt; 0,
</span><span class='line'>]</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>supportsCredentials</code> : クッキーやBasic認証の許可設定</li>
<li><code>allowedOrigins</code> : 許可するドメイン</li>
<li><code>allowedHeaders</code> : 許可するヘッダー</li>
<li><code>allowedMethods</code> : 許可するメソッド</li>
<li><code>exposedHeaders</code> : レスポンスに含める内容があれば</li>
</ul>


<p>それぞれ、 <code>*</code> とすれば全て許可する設定となる。<br/>
(<code>maxAge</code>はよくわからない…）</p>

<p>これで完了。</p>

<h1>CURLで確認</h1>

<p>curlで設定されているかどうかを確認する。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -X GET -I -H "Origin: http://sample.jp" https://your-domain.com/your/api</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>-I</code> : Headerのみ取得し出力</li>
<li><code>-X</code> : アクションメソッドの指定</li>
<li><code>-H</code> : ヘッダの指定</li>
</ul>


<p>ヘッダの <code>Origin</code> に送信元のURLを指定する。<br/>
許可されているドメインの場合は、 <code>200</code> が返ってくるが、<br/>
許可されていない場合は、 <code>403</code> が返ってくる。</p>

<p>OKの場合のレスポンス</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Connection: keep-alive
</span><span class='line'>Date: Mon, 19 Jun 2017 02:17:21 GMT
</span><span class='line'>Server: Apache
</span><span class='line'>Cache-Control: no-cache, private
</span><span class='line'>Access-Control-Allow-Origin: http://sample.jp
</span><span class='line'>Vary: Origin
</span><span class='line'>Transfer-Encoding: chunked
</span><span class='line'>Content-Type: application/json
</span><span class='line'>Via: 1.1 vegur</span></code></pre></td></tr></table></div></figure>


<h1>参考</h1>

<ul>
<li><a href="http://qiita.com/bmf_san/items/a90255bf645890d96d0b">LaravelでCORS対応 &ndash; Qiita</a></li>
<li><a href="https://github.com/barryvdh/laravel-cors">barryvdh/laravel-cors: Adds CORS (Cross-Origin Resource Sharing) headers support in your Laravel application</a></li>
<li><a href="http://qiita.com/polikeiji/items/c8b79554015d75c073f8">curlでCORS設定を確認する &ndash; Qiita</a></li>
<li><a href="https://stackoverflow.com/questions/12173990/how-can-you-debug-a-cors-request-with-curl">How can you debug a CORS request with cURL? &ndash; Stack Overflow</a></li>
<li><a href="http://blog.toshimaru.net/s3-cloudfront-cors-setting/">AWS S3 + CloudFront のCORS設定手順 &ndash; Hack Your Design!</a></li>
<li><a href="http://www.minimalab.com/blog/2014/12/08/curl-option/">Curl の個人的によく使うオプションまとめ</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Laravelで標準出力にエラーログを出力する]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/06/16/larave-std-error/"/>
    <updated>2017-06-16T16:01:28+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/06/16/larave-std-error</id>
    <content type="html"><![CDATA[<p>HerokuでWebサイトを作る場合、ログの出力はPapertrailを入れることが多い、というか必ず利用しています。<br/>
Papertrailでは標準出力に出力したログは漏れなく拾ってくれるので、Laravelも標準出力にエラーログを出力するようにする方法を毎回ググルので備忘録。</p>

<!-- more -->


<h1>設定</h1>

<p>以下の記述を、<code>bootstrap/app.php</code> に追加します。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$app-&gt;configureMonologUsing(function ($monolog) {
</span><span class='line'>    $monolog-&gt;pushHandler(new \Monolog\Handler\StreamHandler('php://stderr'));
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<h1>出力</h1>

<p>以下のようにすると出力可能です。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Log::error('TEST LOG');</span></code></pre></td></tr></table></div></figure>


<h1>結果</h1>

<p>すると、以下のように出力されます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2017-06-16 04:02:16] dev.ERROR: TEST LOG [] [] </span></code></pre></td></tr></table></div></figure>


<p><code>dev.ERROR</code>の<code>dev</code>の部分は、環境変数の<code>APP_ENV</code>で設定している文字列が出ます。<br/>
なので、<code>dev.ERROR</code>とかでひっかけてPapertrailでアラートを設定してやれば自分で出力したエラーログで通知とかが出せたりします。</p>

<h1>参考</h1>

<p>以下、参考にしました。ありがとうございます。</p>

<ul>
<li><a href="http://qiita.com/iakio/items/86086e046f73826c9bef">Laravelのログを標準エラーに出力する &ndash; Qiita</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Vagrantで、Authentication failureのWarningが出た場合の対処]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/04/24/vagrant-authentication-error/"/>
    <updated>2017-04-24T17:21:13+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/04/24/vagrant-authentication-error</id>
    <content type="html"><![CDATA[<p>Vagrantを起動させた場合に、Warningが出て起動しなくなってしまった時にググった対処方のメモ。</p>

<!-- more -->


<h1>環境</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>・ホスト側
</span><span class='line'>Mac OSX 10.11.6
</span><span class='line'>Vagrant 1.8.6
</span><span class='line'>Virtual Box 5.1.6
</span><span class='line'>
</span><span class='line'>・ゲスト側
</span><span class='line'>CentOX 6.5</span></code></pre></td></tr></table></div></figure>


<h1>エラー内容</h1>

<p>以下のエラーが出た。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Warning: Authentication failure. Retrying...</span></code></pre></td></tr></table></div></figure>


<p>起動途中で上記のwarningが連発し、タイムアウトで終了してしまう。</p>

<h1>原因</h1>

<p>vagrant 1.7以降の場合に、vagrantで使用している秘密鍵と公開鍵の不一致？によって引き起こされるエラーのよう。</p>

<h1>対処法</h1>

<p>以下の手順で対処した。</p>

<p><code>Vagrantfile</code>に、ゲストOSの公開鍵を書き換えないように以下の設定を追記。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config.ssh.insert_key = false</span></code></pre></td></tr></table></div></figure>


<p><code>$ vagrant up</code>でvagrantを起動。途中、warningが出るが、<code>ctrl + c</code>で中断する。<br/>
中断してもvagrant自体は立ち上がっているので、<code>$ vagraht ssh</code>でゲストOSにログインする。</p>

<p><code>/home/vagrant/</code>以下に、<code>.ssh</code>ディレクトリがなければ作成する。<br/>
(すでにあったので今回は作成していない)</p>

<p>vagrantの作者のGithubリポジトリから公開鍵を取得し、<code>authorized_keys</code>という名前で保存する。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget --no-check-certificate https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub -O /home/vagrant/.ssh/authorized_keys</span></code></pre></td></tr></table></div></figure>


<p>ファイルやディレクトリのパーミッションを変更する。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chmod 0700 /home/vagrant/.ssh
</span><span class='line'>$ chmod 0600 /home/vagrant/.ssh/authorized_keys
</span><span class='line'>$ chown -R vagrant /home/vagrant/.ssh</span></code></pre></td></tr></table></div></figure>


<p>ホストOS側にある、<code>.vagrant</code>ディレクトリ内の<code>private_key</code>を削除する。
<code>.vagrant/machines/default/virtualbox/private_key</code> を削除。</p>

<p><code>$ vagrant halt</code>で停止する。</p>

<p>これで再度、<code>$ vagrant up</code>することで起動することが出来た。</p>

<h1>参考</h1>

<ul>
<li><a href="http://qiita.com/shyse/items/9ec50b868b90f847c75f">vagrant upコマンド実行時にAuthentication failure.エラーが発生する</a></li>
<li><a href="https://github.com/NetCommons3/NetCommons3/wiki/vagrant-up-%E3%81%A7Authentication-failure.-Retrying...">vagrant up でAuthentication failure. Retrying&hellip;</a></li>
<li><a href="http://qiita.com/megane42/items/1d8ae7444d8c1b10bbd7">Vagrant で作った VM にやってはいけない2つのこと</a></li>
<li><a href="http://qiita.com/t_732_twit/items/2303a0c3f27c288382c5#1-4">Vagrantで自分の作成した公開鍵と秘密鍵を使う方法</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jQueryを使ったCloudinaryのダイレクトアップロード]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/04/11/cloudinary-direct-upload/"/>
    <updated>2017-04-11T18:15:35+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/04/11/cloudinary-direct-upload</id>
    <content type="html"><![CDATA[<p>PHPなどのサーバーサイドのプログラムなしにクライアントのJSだけでCloudinaryにアップロードしてみた。</p>

<!-- more -->


<h1>情報</h1>

<p>Cloudinaryの情報として必要なものは以下。</p>

<ul>
<li>Upload Presets Name(unsigned)</li>
<li>Cloud Name</li>
</ul>


<h2>Upload Presets Name</h2>

<p>Cloudinaryへアップロードする際に、サイズや形式、フィルターなどをプリセットとして登録しておける。<br/>
unsigned アップロード、というのは、たぶん、プリセット名とCloudinaryの名前さえわかっていれば認証なしでアップロード出来る、というものっぽい。<br/>
これは、予め設定画面から有効にしてやる必要がある。</p>

<p><code>Settings</code>の、<code>Upload</code>タブを開くと、<code>Upload presets</code>という項目があるので、そこで、<code>Enable unsigned uploading</code>をクリック。</p>

<p><img src="http://kayakuguri.github.io/images/2017/04/cloudinary_setting_1.jpg" alt="" /></p>

<p>有効となると情報が表示されるので、<code>Name</code>をメモっておく。</p>

<p><img src="http://kayakuguri.github.io/images/2017/04/cloudinary_setting_2.jpg" alt="" /></p>

<h2>Cloud Name</h2>

<p><code>Dashboard</code>に表示されているので、メモっておく。</p>

<p><img src="http://kayakuguri.github.io/images/2017/04/cloudinary_setting_3.jpg" alt="" /></p>

<h1>ライブラリ</h1>

<p>Cloudinaryが作成しているjQuery File Upload用のライブラリがあるのでそちらを利用する。</p>

<ul>
<li><a href="https://github.com/cloudinary/cloudinary_js">cloudinary/cloudinary_js</a></li>
<li><a href="https://github.com/blueimp/jQuery-File-Upload">blueimp/jQuery-File-Upload</a></li>
</ul>


<p>先頭でもろもろ読み込む。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;script src='jquery.min.js' type='text/javascript'&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src='jquery.ui.widget.js' type='text/javascript'&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src='jquery.iframe-transport.js' type='text/javascript'&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src='jquery.fileupload.js' type='text/javascript'&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src='jquery.cloudinary.js' type='text/javascript'&gt;&lt;/script&gt;</span></code></pre></td></tr></table></div></figure>


<p>全部CDNでやった場合は以下。<br/>
公式にはCDNはないので本番の案件では使わない方が無難かも。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;script src='http://kayakuguri.github.io//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js' type='text/javascript'&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src="http://kayakuguri.github.io//code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src='http://kayakuguri.github.io//cdnjs.cloudflare.com/ajax/libs/jquery.iframe-transport/1.0.1/jquery.iframe-transport.min.js' type='text/javascript'&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src='http://kayakuguri.github.io//cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/9.18.0/js/jquery.fileupload.min.js' type='text/javascript'&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src='http://kayakuguri.github.io//cdnjs.cloudflare.com/ajax/libs/cloudinary-jquery-file-upload/2.3.0/cloudinary-jquery-file-upload.min.js' type='text/javascript'&gt;&lt;/script&gt;</span></code></pre></td></tr></table></div></figure>


<p>※バージョンは記事投稿現在(2017/4/11)での最新版(jQueryは古い）</p>

<h1>アップロードフォーム</h1>

<h2>inputタグを自動生成</h2>

<p>単純にアップロードするだけなら、自動でinputタグを挿入してくれる関数がある。</p>

<p>[HTML]</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;div class="upload_form"&gt;&lt;/div&gt;</span></code></pre></td></tr></table></div></figure>


<p>[JS]</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$(function () {
</span><span class='line'>  $('.upload_form').append($.cloudinary.unsigned_upload_tag("preset-name-here", { cloud_name: 'cloud-name-here' }));
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>ライブラリを読み込んで、これで<code>append</code>すれば、自動的に、<code>&lt;input&gt;</code>タグが挿入される。<br/>
そこでファイルを選択すれば、アップロードが行われる。<br/>
(選ぶだけでアップロードされる）</p>

<p>以下のようなHTMLが挿入される。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;input type="file" name="file" class="cloudinary_fileupload"&gt;</span></code></pre></td></tr></table></div></figure>


<h2>bind</h2>

<p>アップロードされた後や、アップロード中に処理をおこないたい場合は、<code>bind</code>する。<br/>
そのために、自分で<code>&lt;input&gt;</code>タグを作っておき、そのタグにたいして<code>bind</code>する。</p>

<p>[HTML]</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;input type="file" name="file" id="upload_form" /&gt;
</span><span class='line'>&lt;div class="progress"&gt;&lt;/div&gt;
</span><span class='line'>&lt;div class="thumbnails"&gt;&lt;/div&gt;</span></code></pre></td></tr></table></div></figure>


<p>[JS]</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$(function () {
</span><span class='line'>  $.cloudinary.config({ cloud_name: 'cloud_name_here'});
</span><span class='line'>  $('#upload_form').unsigned_cloudinary_upload('preset_name_here',
</span><span class='line'>    { cloud_name: 'cloud_name_here', tags: 'browser_uploads' },
</span><span class='line'>    { multiple: true }
</span><span class='line'>  )
</span><span class='line'>  .bind('cloudinaryprogress', function(e, data) {
</span><span class='line'>    $('.progress').text('アップロード中...');
</span><span class='line'>  })
</span><span class='line'>  .bind('cloudinarydone', function(e, data) {
</span><span class='line'>      $('.progress').text('完了');
</span><span class='line'>      $('.thumbnails').append($.cloudinary.image(data.result.public_id,
</span><span class='line'>        { format: 'jpg', width: 150, height: 100, crop: 'thumb' } ));
</span><span class='line'>    }
</span><span class='line'>  );
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p><code>cloudinaryprogress</code>がアップロード中の処理。アップロード中、というテキストを表示しているだけ。<br/>
<code>cloudinarydone</code>がアップロード後の処理。完了、と表示させ、サムネイルを取得して表示している。</p>

<p><code>$.cloudinary.image(name, option)</code>で画像を取得して表示させることが可能。<br/>
冒頭で<code>cloud_name</code>を設定している。
<code>data.result.public_id</code>でアップロードしたファイルのIDが取得可能。</p>

<p>ファイルのURLを直接参照したい場合は以下。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$.cloudinary.url(data.result.public_id);</span></code></pre></td></tr></table></div></figure>


<p>第二引数でサイズやクロップなどのオプションを指定してやることが可能。</p>

<h1>注意</h1>

<p>注意点としては、ファイルの選択を行っただけでアップロードが開始されてしまうところ。<br/>
これを送信ボタンをクリックした時にアップロードを開始するようには変更出来るのだろうか…。<br/>
ライブラリに手を入れないと無理な気もする…。</p>

<h1>参考</h1>

<h2>公式</h2>

<ul>
<li><a href="http://cloudinary.com/blog/direct_upload_made_easy_from_browser_or_mobile_app_to_the_cloud#direct_uploading_from_the_browser_using_jquery">Direct uploading from the browser using jQuery</a></li>
<li><a href="http://cloudinary.com/documentation/jquery_integration">jQuery integration</a></li>
<li><a href="http://cloudinary.com/documentation/jquery_image_manipulation">jQuery image manipulation</a></li>
</ul>


<h2>コードの参考</h2>

<ul>
<li><a href="http://www.nerdtutorials.com/cloudinary-image-uploader-sponsored/">Cloudinary Image Uploader (Sponsored)</a></li>
<li><a href="http://stackoverflow.com/questions/40438882/restrict-uploading-file-size-greater-than-20-mb-cloudinary-api">restrict uploading file size greater than 20 mb [cloudinary api]</a></li>
</ul>


<h1>コード全文</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!doctype html&gt;
</span><span class='line'>
</span><span class='line'>&lt;html lang="ja"&gt;
</span><span class='line'>&lt;head&gt;
</span><span class='line'>  &lt;meta charset="utf-8"&gt;
</span><span class='line'>
</span><span class='line'>&lt;script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js' type='text/javascript'&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src='https://cdnjs.cloudflare.com/ajax/libs/jquery.iframe-transport/1.0.1/jquery.iframe-transport.min.js' type='text/javascript'&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src='https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/9.18.0/js/jquery.fileupload.min.js' type='text/javascript'&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src='https://cdnjs.cloudflare.com/ajax/libs/cloudinary-jquery-file-upload/2.3.0/cloudinary-jquery-file-upload.min.js' type='text/javascript'&gt;&lt;/script&gt;
</span><span class='line'>
</span><span class='line'>&lt;script&gt;
</span><span class='line'>$(function () {
</span><span class='line'>  $.cloudinary.config({ cloud_name: 'cloud_name_here'});
</span><span class='line'>  $('#upload_form').unsigned_cloudinary_upload('preset_name_here',
</span><span class='line'>    { cloud_name: 'cloud_name_here', tags: 'browser_uploads' },
</span><span class='line'>    { multiple: true }
</span><span class='line'>  )
</span><span class='line'>  .bind('cloudinaryprogress', function(e, data) {
</span><span class='line'>    $('.progress').text('アップロード中...');
</span><span class='line'>  })
</span><span class='line'>  .bind('cloudinarydone', function(e, data) {
</span><span class='line'>      $('.progress').text('完了');
</span><span class='line'>      $('.thumbnails').append($.cloudinary.image(data.result.public_id,
</span><span class='line'>        { format: 'jpg', width: 150, height: 100, crop: 'thumb' } ));
</span><span class='line'>      var direct_url = $.cloudinary.url(data.result.public_id);
</span><span class='line'>    }
</span><span class='line'>  );
</span><span class='line'>});
</span><span class='line'>&lt;/script&gt;
</span><span class='line'>  &lt;title&gt;Cloudinary Upload Sample&lt;/title&gt;
</span><span class='line'>&lt;/head&gt;
</span><span class='line'>
</span><span class='line'>&lt;body&gt;
</span><span class='line'>&lt;h1&gt;Cloudinary Upload Test&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;div&gt;&lt;input type="file" name="file" id="upload_form" /&gt;&lt;/div&gt;
</span><span class='line'>&lt;div class="progress"&gt;&lt;/div&gt;
</span><span class='line'>&lt;div class="thumbnails"&gt;&lt;/div&gt;
</span><span class='line'>
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[salesforce] レコードのデータを取得し、CSVにしてS3にアップロードする]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/04/10/put-s3-csv-file/"/>
    <updated>2017-04-10T12:31:25+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/04/10/put-s3-csv-file</id>
    <content type="html"><![CDATA[<p>AWSで利用する事を想定し、レコードの内容をCSVファイルにしてS3にアップロードしてみたメモ。</p>

<!-- more -->


<p>SF内にCSVを生成して、そのファイルをS3にアップロード、すればいいかと思っていたが、直接CSVの内容をBodyに入れて送ってしまうことで、直接CSVファイルをS3に送信してしまう事が出来た。</p>

<h1>参考コード</h1>

<p>参考、というか、以下のコードをそのまま利用させてもらった。</p>

<ul>
<li><a href="https://github.com/darshanfarswan/haymarketCode/blob/6207a11fc072fed6dd4463b1ca4ebbbe991a232f/src/classes/S3Storage.cls">haymarketCode/src/classes/S3Storage.cls</a></li>
</ul>


<h1>CSV送信</h1>

<p>上記サンプルはテキストファイルになるので、CSVを保存するように変更。<br/>
具体的には、Bodyの内容をカンマ区切りにし、ファイルの拡張子を<code>csv</code>にし、Content-Typeを<code>text/csv</code>にする、だけ。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public with sharing class SaveCSVSample {
</span><span class='line'>  public SaveCSVSample() {
</span><span class='line'>      String csv_body = 'テスト1,テスト2,テスト3\r\nサンプル1,サンプル2,サンプル3';
</span><span class='line'>
</span><span class='line'>      String fileName = 'test.csv';
</span><span class='line'>
</span><span class='line'>      String accessId = 'xxx';
</span><span class='line'>      String secretKey = 'xxx';
</span><span class='line'>      String bucketName = 'user';
</span><span class='line'>      String S3_Domain = 's3-ap-northeast-1.amazonaws.com';
</span><span class='line'>
</span><span class='line'>      String dateString = Datetime.now().formatGmt('EEE, dd MMM yyyy HH:mm:ss Z');
</span><span class='line'>      String stringToSign = 'PUT\n\ntext/csv\n' + dateString +'\n/' + bucketName + '/' + fileName;
</span><span class='line'>      Blob mac = Crypto.generateMac('hmacSHA1',  Blob.valueOf(stringToSign), Blob.valueOf(secretKey));
</span><span class='line'>      String signature = EncodingUtil.base64Encode(mac);
</span><span class='line'>
</span><span class='line'>      HttpRequest req = new HttpRequest();
</span><span class='line'>      req.setEndPoint('https://' + bucketName + '.' + S3_Domain + '/' + fileName);
</span><span class='line'>      req.setHeader('Content-Type', 'text/csv');
</span><span class='line'>      req.setHeader('Content-Length', String.valueOf(csv_body.length()));
</span><span class='line'>      req.setHeader('Host', bucketName + '.' + S3_Domain);
</span><span class='line'>      req.setHeader('Date', dateString);
</span><span class='line'>      req.setHeader('Authorization','AWS ' + accessId + ':' + signature);
</span><span class='line'>      req.setBody(csv_body);
</span><span class='line'>      req.setMethod('PUT');
</span><span class='line'>
</span><span class='line'>      Http httpConnection = new Http();
</span><span class='line'>      HTTPResponse res = httpConnection.send(req);
</span><span class='line'>
</span><span class='line'>      System.debug(res);
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>アップされたCSVは、改行コード <code>\r\n</code> 、文字コードは、<code>UTF-8</code>となった。</p>

<p>これでS3側にCSVファイルを作成出来るので、あとはレコードをSOQLで取得し、Bodyをカンマ区切りで作成してやればよいだけ。</p>

<h2>環境情報</h2>

<p>この例では、アクセスキーなどはベタで書いてしまっているが、実際には<a href="https://kayakuguri.github.io/blog/2016/02/01/custom-setting/">カスタム設定などで作成し</a>取得するようにした方がよい。<br/>
それだと、sandboxと本番でS3の投げ先も変更出来る。</p>

<h2>エンドポイント</h2>

<p>送信先に設定している、<code>S3_Domain</code>は現状、日本リージョンのもの。<br/>
各サービスのリージョン別のエンドポイントは以下を参考。<br/>
<a href="http://docs.aws.amazon.com/ja_jp/general/latest/gr/rande.html#s3_region">http://docs.aws.amazon.com/ja_jp/general/latest/gr/rande.html#s3_region</a></p>

<h2>ガバナ制限</h2>

<blockquote><p>ファイルサイズが3MBを超えるとApexの実行時ガバナ制限に抵触する<br/>
<a href="http://www30304u.sakura.ne.jp/blog/?p=1808">http://www30304u.sakura.ne.jp/blog/?p=1808</a></p></blockquote>

<h1>参考</h1>

<ul>
<li><a href="http://www.nkjmkzk.net/?p=2638">CORSサポートを利用したAWS S3へのアップロード方法 – Force.comバージョン</a></li>
<li><a href="http://blog.livedoor.jp/volvic_beer/archives/52481242.html">【salesforce】【apex】【aws】apexでs3にアップロードでエラーがでたよ</a></li>
<li><a href="http://dev.classmethod.jp/cloud/aws/s3-cors-upload/">WebブラウザからAmazon S3に直接ファイルをアップロードする</a></li>
<li><a href="http://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/RESTAuthentication.html">REST リクエストの署名と認証</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[開発者コンソールで表示させるデバッグログのレベルを変更する]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/04/10/change-debug-log-level/"/>
    <updated>2017-04-10T11:45:42+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/04/10/change-debug-log-level</id>
    <content type="html"><![CDATA[<p>開発者コンソールを開いていると、ログインしているユーザーのデバッグログを直接参照する事が出来る。
このログは、ログレベルがデフォルトの設定になっているが、色んなログが大量に出てしまう。</p>

<!-- more -->


<p><code>Debug Only</code>にチェックをつければ自分で出力したログだけを表示してくれたり、<code>Filter</code>機能があるのでみたいログだけに絞って表示させることは比較的容易に出来る。<br/>
しかし、そもそもログの内容が多すぎて、出力出来る最大サイズを越えてしまうことがたまにある。<br/>
そんな時は余計なログは出力させないようにデバッグレベルを調整してやる必要がある。</p>

<p><img src="http://kayakuguri.github.io/images/2017/04/debug_log_level_01.jpg" alt="" /></p>

<p>(匿名実行のログを表示させたところ）</p>

<p>開発者コンソールじゃなくて、SFの設定からデバッグログを設定してやる場合はデバッグレベル名を必須で選択するので、レベルの調整が可能なことはわかっていたが、開発者コンソールでもこのデバッグレベルを変更出来た。</p>

<h1>デバッグレベル</h1>

<p>まず、予めデバッグレベルを作成しておく。<br/>
<code>設定 -&gt; ログ -&gt; デバッグレベル</code> にアクセス。</p>

<p>新規、から作成。</p>

<p>名前は適当に設定し、レベルは欲しい情報に絞ったりして調整する。<br/>
例えば、Apexで<code>System.debug()</code>で出力したものは、Apexコードで、レベルを <code>デバッグ</code> にしておけば出力される。<br/>
(それ以外のカテゴリはなし、で問題ない）</p>

<p><img src="http://kayakuguri.github.io/images/2017/04/debug_log_level_02.jpg" alt="" /></p>

<h1>ログレベルの変更</h1>

<p>開発者コンソールのメニューから、 <code>Debug -&gt; Change Log Levels</code> を選択。<br/>
<img src="http://kayakuguri.github.io/images/2017/04/debug_log_level_03.jpg" alt="" /></p>

<p>ログレベルの選択画面がモーダルで表示される。<br/>
一番上の、<code>General Trace Settings for You</code>が、開発者コンソールで表示されるログのレベルの設定となる。<br/>
現状は、デフォルトのレベルが設定されているはずなので、一番右の項目にある、 <code>Add/Change</code> をクリック。</p>

<p><img src="http://kayakuguri.github.io/images/2017/04/debug_log_level_04.jpg" alt="" /></p>

<p>デフォルトのレベルと、先ほど設定したレベルが表示されるので、設定したレベルを選択し、<code>Done</code>をクリック。</p>

<p><img src="http://kayakuguri.github.io/images/2017/04/debug_log_level_05.jpg" alt="" /></p>

<p>実は、予めレベルをSF側から作成しなくても、ここで、<code>Add</code>して作成する事も可能。<br/>
さらに、各カテゴリのレベルもここから変更する事も出来る。</p>

<p>これで設定は完了。先ほどの匿名実行と同じ内容でログを出力してみると、大幅に内容が減っているのが確認出来る。</p>

<p><img src="http://kayakuguri.github.io/images/2017/04/debug_log_level_07.jpg" alt="" /></p>

<p>また、実はSF側のデバッグログのページを確認すると、開発者コンソールを起動させた時点で設定したデバッグレベル・ログイン中のユーザーの状態で、デバッグログが自動的にセットされている。</p>

<p><img src="http://kayakuguri.github.io/images/2017/04/debug_log_level_06.jpg" alt="" /></p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Apex]エスケープ文字を置換する]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/01/26/apex-replase-escape/"/>
    <updated>2017-01-26T18:25:10+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/01/26/apex-replase-escape</id>
    <content type="html"><![CDATA[<p>apexにて取得した文字列から、エスケープ文字である、 <code>\</code> を取り除きたかったので、置換してみた。</p>

<!-- more -->


<h1>replaceAll</h1>

<p><code>replaceAll</code>を使用すれば全置換が出来るのだが、以下のように指定してしまうと <code>'</code> をエスケープしていることになるのでプログラムが破綻してエラーになっていまう。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hoge.replaceAll('\', '');</span></code></pre></td></tr></table></div></figure>


<blockquote><p>エラー : line breaks not allowed in string literals</p></blockquote>

<p>なので、エスケープ文字をエスケープしてやればいいのでは、と思ったが、これだとエラーが出てしまった。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hoge.replaceAll('\\', '');</span></code></pre></td></tr></table></div></figure>


<blockquote><p>エラー : System.StringException: Invalid regex: Unexpected internal error near index 1 \ ^</p></blockquote>

<p>正規表現が間違ってますよ、というような感じ？</p>

<p>なので、正規表現として指定してやればいけた。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hoge.replaceAll('\\$', '');</span></code></pre></td></tr></table></div></figure>


<p>以上。<br/>
以下、蛇足。</p>

<h1>なぜ必要になったか</h1>

<p>以前書いた、<a href="http://kayakuguri.github.io/blog/2016/11/17/forrest-sfapi-laravel/">LaravelのSF接続用パッケージのforrest</a>を利用してデータの送信を行っていたのだが、<br/>
通常の配列のパラメータを送るのは問題なく出来ていたのだが、カスタムエンドポイントにJSONのデータをbodyに入れて送信するとapex側でパースエラーが出てしまった。<br/>
JSONデータは以前書いた方法でパースしている。<br/>
<a href="http://kayakuguri.github.io/blog/2015/12/08/json-apex-parse/">ApexでJSONをパースする</a></p>

<p>その内容が、上記のエスケープ文字がJSONデータに混ざり込んでいたため、だった。<br/>
なら、JSONデータからエスケープ文字を取り除いてやればよいのでは、と思い調べると、以下のようにJSONをエンコードするとエスケープされない事がわかった。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>json_encode($hoge, JSON_UNESCAPED_SLASHES);</span></code></pre></td></tr></table></div></figure>


<p>第二引数に<code>JSON_UNESCAPED_SLASHES</code>を指定してやるだけでよい。<br/>
しかし、これを行ってもエスケープ文字が消えない。これはもしかして、ライブラリ側でエスケープをしているのでは、と思いコードを確認するとやはり以下の箇所で<code>body</code>に指定された値に<code>json_encode</code>をかけており、ここでは第二引数には何も指定されていなかった。</p>

<p><a href="https://github.com/omniphx/forrest/blob/master/src/Omniphx/Forrest/Client.php#L775">https://github.com/omniphx/forrest/blob/master/src/Omniphx/Forrest/Client.php#L775</a></p>

<p>ならば、設定ファイルでフォーマットの形式を指定する箇所があったので、そこで<code>none</code>を指定してやった。</p>

<p><a href="https://github.com/omniphx/forrest/blob/master/src/config/config.php#L50">https://github.com/omniphx/forrest/blob/master/src/config/config.php#L50</a></p>

<p>しかし上記の<code>json_encode</code>している箇所をよくみるとわかるのだが、フォーマットが指定されていない場合は、<code>body</code>を<a href="https://github.com/omniphx/forrest/blob/master/src/Omniphx/Forrest/Client.php#L772">空にして送る</a>ようになってしまっていた。</p>

<p>これは、必ずエスケープするという方針によるものなのか、単なる実装し忘れなのかわからないが、パッケージの中身を触るわけにもいかず<br/>
(オーバーラップして自分で実装し直すのも面倒なので）<br/>
apex側で置換してやったほうがよさそう、ということで本エントリー内容を試すこととなった、という顛末。</p>

<h2>参考</h2>

<ul>
<li><a href="http://blog.higty.xyz/archives/530/">php json_encode で&#8221;/&ldquo;のエスケープ</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Scotchbox]Ubuntuの環境でのphp.ini]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/01/11/scotchbox-phpini/"/>
    <updated>2017-01-11T18:21:48+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/01/11/scotchbox-phpini</id>
    <content type="html"><![CDATA[<p>ちょっとしたメモ。<br/>
ScotchboxのデフォルトUbuntu環境での<code>php.ini</code>の場所にハマったので、そのメモ。</p>

<!-- more -->


<h2>正解</h2>

<p>結論から書くと、以下のファイルでの設定が有効となっていた。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/php5/apache2/php.ini</span></code></pre></td></tr></table></div></figure>


<h2>間違い</h2>

<p>実は以下にも<code>php.ini</code>があるのだが、これの内容を変更しても反映されなかった。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/php5/cli/php.ini  //反映されない</span></code></pre></td></tr></table></div></figure>


<hr />

<p>そもそも何を設定したかというと、<br/>
他のUbuntu環境を知らないので、Scotchbox特有かどうかはわからないけれど、デフォルトではスーパーグローバル変数の環境変数ではる、<code>$_ENV</code> が有効となっていないため、それを有効とすべく、<code>php.ini</code>の設定を触る必要があった。</p>

<ul>
<li><a href="http://kayakuguri.github.io/blog/2015/05/26/vagrant-env/">Vagrant環境での環境変数の設定方法</a></li>
</ul>


<p>以上、メモ。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Herokuで独自ドメインを指定する際に使用するターゲット名]]></title>
    <link href="http://kayakuguri.github.io/blog/2017/01/05/heroku-custom-domain/"/>
    <updated>2017-01-05T18:17:32+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2017/01/05/heroku-custom-domain</id>
    <content type="html"><![CDATA[<p>Herokuで独自ドメインを指定するには、CNAMEでHeroku側のドメインを指定して設定してやる必要がある。</p>

<!-- more -->


<ul>
<li><a href="http://kayakuguri.github.io/blog/2014/09/30/heroku-ssl-subdomain/">[heroku]herokuでのSSL設定とカスタムサブドメインの適用方法</a></li>
</ul>


<h1>少し前までのターゲット</h1>

<p>少し前まで（具体的には<a href="https://blog.heroku.com/announcing_heroku_free_ssl_beta_and_flexible_dyno_hours">SSLの設定がHerokuの標準機能に組み込まれる</a>まで）は、以下のような設定内容で設定していた。<br/>
（アプリ名を <code>appname</code> とし、設定するサブドメインは、<code>www.appname.com</code> とする)</p>

<table>
<thead>
<tr>
<th></th>
<th align="left"> 種類 (Record) </th>
<th align="left"> 名前 (Name) </th>
<th align="left"> 内容 (Target) </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td align="left"> CNAME </td>
<td align="left"> <code>www</code> </td>
<td align="left"> <code>appname.herokuapp.com</code></td>
</tr>
</tbody>
</table>


<h1>Heroku Free SSL導入後のターゲット</h1>

<h2>注意</h2>

<p>ここでの説明はあくまでも独自<strong>サブドメイン</strong>の設定方法となる。<br/>
ルートドメインをHerokuのアプリで使用したい場合は、別途PointDNSアドオンや、AWSのRoot53などのサービスを使用する必要があるが、ここでは割愛する（どれがデファクトスタンダードかまだ決まりきってない印象）。<br/>
なので、CNAMEでの設定となり、Aレコードでの設定ではないので注意。<br/>
(herokuは固定IPではないので、通常はAレコードは使用出来ない）</p>

<h2>前提</h2>

<p>今まで、Herokuに独自のSSL証明書を適用させるためには <a href="https://elements.heroku.com/addons/ssl">Heroku SSLのアドオン</a> が必要だったのだが、<br/>
<strong>FreeDyno以外の有料アプリに限り</strong>デフォルトでSSLの設定が出来るようになった。<br/>
しかもブラウザ上からドラッグアンドドロップでファイルをアップ出来るようになったため無料かつ便利になった。</p>

<p>(無料Dynoでの利用の場合はアドオンの追加が必要になるのだが、一番安い<code>hobby dyno</code>は月$7/1dyno、で、SSLアドオン 月$20、なので、有料dynoにした方が安いため、アドオンで設定するメリットはほぼないと思われる）</p>

<h2>ターゲットの変更</h2>

<p>そのタイミングで、CNAMEとして設定するターゲット名も変更になった。<br/>
今までは、 <code>hokkaido-1212.herokussl.com</code> など、都道府県が入ったようなランダムな名前だったのだが、新しく、 <code>www.appname.com.herokudns.com</code> というような名前となった。<br/>
以下のようになるよう。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{設定するサブドメイン}.herokudns.com</span></code></pre></td></tr></table></div></figure>


<h2>ターゲット名</h2>

<p>よって、CNAMEでの設定も内容の部分が変更となる。<br/>
このターゲット名だが、<strong>SSLを使用の有無、無料・有料Dynoに関わらず</strong>、一律で <code>herokudns.com</code> の指定となる。</p>

<p>Herokuの設定画面から設定した場合は以下のような感じで表示がされるので、<code>DNA Target</code>の部分を使用すればよい。</p>

<p><img src="http://kayakuguri.github.io/images/2017/01/custom_domain01.jpg" alt="" /></p>

<p>コマンドで確認した場合は以下のような感じになる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku domains -a appname
</span><span class='line'>=== appname Heroku Domain
</span><span class='line'>appname.herokuapp.com
</span><span class='line'>
</span><span class='line'>=== appname Custom Domains
</span><span class='line'>Domain Name      DNS Target
</span><span class='line'>───────────────  ─────────────────────────────
</span><span class='line'>www.appname.com  www.appname.com.herokudns.com</span></code></pre></td></tr></table></div></figure>


<h2>CNAMEの設定</h2>

<p>よって、設定内容は以下のようになる。</p>

<table>
<thead>
<tr>
<th></th>
<th align="left"> 種類 (Record) </th>
<th align="left"> 名前 (Name) </th>
<th align="left"> 内容 (Target) </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td align="left"> CNAME </td>
<td align="left"> <code>www</code> </td>
<td align="left"> <code>www.appname.com.herokudns.com</code></td>
</tr>
</tbody>
</table>


<h1>参考</h1>

<ul>
<li><a href="https://devcenter.heroku.com/articles/custom-domains">Custom Domain Names for Apps | Heroku Dev Center</a></li>
<li><a href="http://www.ucom.ne.jp/enterprise/dnsmanual/p4_4_1_4.html">DNS設定ツールマニュアルWEB</a>

<ul>
<li>CNAME設定がどんなものなのかのイメージに</li>
</ul>
</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PostmanでSalesforce REST APIに接続]]></title>
    <link href="http://kayakuguri.github.io/blog/2016/12/07/sf-rest-api-postman/"/>
    <updated>2016-12-07T16:27:12+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2016/12/07/sf-rest-api-postman</id>
    <content type="html"><![CDATA[<p>以前まではRestAPIの接続確認には、<a href="https://apigee.com/providers">Apigee</a>を使用していたのだけれど、TLS1.0無効化の問題の影響からsandboxでは接続できなくなってしまった。<br/>
なので、代替としてちょっとめんどうだけれど、Postmanで接続してみた。</p>

<!-- more -->


<h1>アクセストークンの取得</h1>

<p>ドメインは、sandboxの場合は、 <code>test.salesforce.com</code> 、本番は、 <code>login.salesforce.com</code> となる。<br/>
今回はsandboxで試す。</p>

<p>Postmanにて、以下の内容で送信。</p>

<blockquote><p>POST : <a href="https://test.salesforce.com/services/oauth2/token">https://test.salesforce.com/services/oauth2/token</a></p></blockquote>

<ul>
<li><code>grant_type</code> : <code>password</code></li>
<li><code>client_id</code> : 接続アプリケーションのコンシューマ鍵</li>
<li><code>client_secret</code> : 接続アプリケーションのコンシューマの秘密</li>
<li><code>username</code> : 使用するアカウントのユーザ名</li>
<li><code>password</code> : パスワード。必要な場合は、パスワード+セキュリティトークン</li>
</ul>


<p><img src="http://kayakuguri.github.io/images/2016/12/sf_api_postman_01.jpg" alt="" /></p>

<p>正しくログイン出来ると以下のようにJSONが返ってくる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "access_token": "xxx",
</span><span class='line'>  "instance_url": "https://xxxx.salesforce.com",
</span><span class='line'>  "id": "https://test.salesforce.com/id/xxxx/xxxx",
</span><span class='line'>  "token_type": "Bearer",
</span><span class='line'>  "issued_at": "xxx",
</span><span class='line'>  "signature": "xxx"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>access_token</code>と<code>instance_url</code>だけ必要。</p>

<h1>APIに接続</h1>

<p>例として、オブジェクトの一覧を取得してみる。<br/>
URLのドメイン部分を先程取得した、 <code>instance_url</code> を使用する。</p>

<blockquote><p>GET : <a href="https://xxx.salesforce.com/services/data/v24.0/sobjects">https://xxx.salesforce.com/services/data/v24.0/sobjects</a></p></blockquote>

<p>ヘッダーに以下を追加。<br/>
<code>ACCESS_TOKEN</code>には先程取得した、<code>access_token</code>を使用する。</p>

<ul>
<li><code>Authorization</code> : <code>Bearer ACCESS_TOKEN</code></li>
</ul>


<p><img src="http://kayakuguri.github.io/images/2016/12/sf_api_postman_02.jpg" alt="" /></p>

<p>カスタムRestAPIの場合は以下のURLになる。<br/>
<code>hoge/hoge</code>が<code>@RestResource(urlMapping='/hoge/hoge')</code>で指定したURLとなる。</p>

<blockquote><p><a href="https://xxx.salesforce.com/services/apexrest/hoge/hoge">https://xxx.salesforce.com/services/apexrest/hoge/hoge</a></p></blockquote>

<h1>参考</h1>

<ul>
<li><a href="http://sfdcbeginner.com/how-to-test-salesforce-rest-api.html">HOW TO TEST SALESFORCE REST API</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ScotchboxでのPHPエラーの出力場所]]></title>
    <link href="http://kayakuguri.github.io/blog/2016/12/05/ubuntu-error-log/"/>
    <updated>2016-12-05T17:02:15+09:00</updated>
    <id>http://kayakuguri.github.io/blog/2016/12/05/ubuntu-error-log</id>
    <content type="html"><![CDATA[<p>自分用メモ。<br/>
<a href="https://box.scotch.io/">Scotchbox</a>のVagrant環境で、PHPの標準エラー出力がどこに吐かれるかをいつも調べるのでメモ。</p>

<!-- more -->


<h1>環境</h1>

<p>環境は以下。</p>

<ul>
<li>Scotchbox 2.5</li>
<li>Ubuntu 14.04 LTS</li>
<li>PHP 5.6</li>
</ul>


<p>純粋なUbuntuでも同じ場所にログが出力されるのかは調査していないので、あくまでもScotchbox環境、とする</p>

<h1>結果</h1>

<p>結論から書くと、以下のパスに保存されていた。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/var/log/apache2/error.log</span></code></pre></td></tr></table></div></figure>


<p>というわけで、<code>tail</code>する場合は以下。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># tail -f /var/log/apache2/error.log</span></code></pre></td></tr></table></div></figure>


<h1>設定内容</h1>

<p>出力するパスは、以下のファイルで設定されている。<br/>
<code>/etc/apache2/sites-available/000-default.conf</code></p>

<p>内容</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;VirtualHost *:80&gt;
</span><span class='line'>  ...
</span><span class='line'>  ErrorLog ${APACHE_LOG_DIR}/error.log
</span><span class='line'>  ...
</span><span class='line'>&lt;/VirtualHost&gt;  </span></code></pre></td></tr></table></div></figure>


<p><code>APACHE_LOG_DIR</code>という環境変数で設定されていることがわかる。<br/>
では、この環境変数はどこで設定しているかというと、以下のファイル。</p>

<p><code>/etc/apache2/envvars</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>...
</span><span class='line'>export APACHE_LOG_DIR=/var/log/apache2$SUFFIX
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>というわけで、冒頭のディレクトリに保存されていた。<br/>
もし変更したい場合は上記<code>envvars</code>にて変更すればよさそう。<br/>
(パーミッションの設定を与えてやる必要はあると思う。)</p>
]]></content>
  </entry>
  
</feed>
